# PDF批改问题修复说明

## 修复的问题

### 1. ✅ 环境变量加载问题

**问题**: `config.py` 没有自动加载 `.env` 文件，导致API密钥无法读取

**修复**:
- 在 `config.py` 开头添加了 `.env` 文件自动加载逻辑
- 支持从 `ai_correction/.env` 或项目根目录 `.env` 加载配置
- 如果未安装 `python-dotenv`，会优雅降级

**代码位置**: `ai_correction/config.py` (第10-27行)

### 2. ✅ LangGraph并发更新错误

**问题**: 多个并行节点（question_understanding, answer_understanding, rubric_interpretation）同时更新 `task_id` 等字段，导致错误：
```
At key 'task_id': Can receive only one value per step. Use an Annotated key to handle multiple values.
```

**修复**:
- 修改了三个并行Agent，让它们只返回需要更新的字段，而不是完整状态
- `QuestionUnderstandingAgent`: 只返回 `question_understanding`, `progress_percentage`, `current_step`
- `AnswerUnderstandingAgent`: 只返回 `answer_understanding`, `progress_percentage`, `current_step`
- `RubricInterpreterAgent`: 只返回 `rubric_understanding`, `progress_percentage`, `current_step`

**修改的文件**:
- `ai_correction/functions/langgraph/agents/question_understanding_agent.py`
- `ai_correction/functions/langgraph/agents/answer_understanding_agent.py`
- `ai_correction/functions/langgraph/agents/rubric_interpreter_agent.py`

### 3. ✅ API密钥检查改进

**问题**: 批改脚本无法正确检测API密钥配置

**修复**:
- 更新了 `batch_correct_pdfs.py`，使用 `config.py` 中已加载的配置
- 显示当前使用的LLM Provider
- 提供更清晰的错误提示

**代码位置**: `ai_correction/batch_correct_pdfs.py` (第458-475行)

## 使用方法

### 1. 配置环境变量

在 `ai_correction/.env` 文件中添加：

```bash
# LLM配置
LLM_PROVIDER=openrouter  # 或 gemini, openai
OPENROUTER_API_KEY=your-api-key-here
# 或者使用通用密钥
LLM_API_KEY=your-api-key-here

# 多模态模型配置（可选）
OPENROUTER_MODEL=google/gemini-2.5-flash-lite
GEMINI_MODEL=gemini-2.0-flash-exp
OPENAI_MODEL=gpt-4
```

### 2. 运行批改脚本

```bash
cd ai_correction
python batch_correct_pdfs.py
```

脚本会自动：
- ✅ 加载 `.env` 文件配置
- ✅ 检查API密钥
- ✅ 处理PDF文件
- ✅ 使用LangGraph工作流进行批改
- ✅ 实时追踪进度和错误
- ✅ 保存批改结果

## 当前状态

### ✅ 已修复
1. 环境变量自动加载
2. LangGraph并发更新错误
3. API密钥检查

### ⚠️ 仍需注意
1. **API密钥**: 确保 `.env` 文件中配置了有效的API密钥
2. **扫描版PDF**: 批改标准PDF是扫描版，需要Vision API支持或安装 `pdf2image`
3. **网络连接**: 确保可以访问OpenRouter API

## 测试建议

1. **检查配置加载**:
   ```python
   from config import OPENROUTER_API_KEY, LLM_PROVIDER
   print(f"Provider: {LLM_PROVIDER}")
   print(f"API Key: {'已配置' if OPENROUTER_API_KEY else '未配置'}")
   ```

2. **测试API连接**:
   ```python
   from functions.llm_client import get_llm_client
   client = get_llm_client()
   response = client.chat([{"role": "user", "content": "测试"}])
   print(response)
   ```

3. **运行批改**:
   ```bash
   python batch_correct_pdfs.py
   ```

## 故障排查

### 问题1: API认证失败 (401)
- 检查 `.env` 文件是否存在
- 检查API密钥是否正确
- 检查API密钥是否有效（在OpenRouter网站验证）

### 问题2: 并发更新错误
- 已修复，如果仍出现，检查是否有其他Agent也在更新只读字段

### 问题3: PDF处理失败
- 检查PDF文件是否存在
- 检查文件是否损坏
- 扫描版PDF需要Vision API支持

## 下一步优化

1. ⏳ 添加重试机制
2. ⏳ 改进错误处理
3. ⏳ 支持批量处理
4. ⏳ 优化扫描版PDF处理流程


