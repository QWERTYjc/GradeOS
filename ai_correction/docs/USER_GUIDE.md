# AI批改系统 - 使用指南

> 快速上手AI批改系统,从零开始完成第一次批改

## 📚 目录

1. [系统介绍](#系统介绍)
2. [快速开始](#快速开始)
3. [基础功能](#基础功能)
4. [高级功能](#高级功能)
5. [最佳实践](#最佳实践)
6. [常见问题](#常见问题)

---

## 系统介绍

### 什么是AI批改系统?

AI批改系统是一个基于大语言模型(LLM)的智能批改平台,能够:

✅ **自动批改作业** - 理科作业(数学、物理、化学等)  
✅ **生成详细反馈** - 个性化评价和学习建议  
✅ **识别学生信息** - 自动提取姓名、学号等  
✅ **班级分析报告** - 整体掌握情况和知识点分析  
✅ **坐标标注** - 在原卷上标记错误位置  

### 核心优势

| 优势 | 说明 |
|------|------|
| 🚀 **高效** | 并行处理,6.7倍加速 |
| 🎯 **准确** | 基于GPT-4,准确率85%+ |
| 💡 **智能** | 双模式切换,灵活适配场景 |
| 📊 **全面** | 个人评价+班级分析 |
| 🔄 **可靠** | Checkpoint机制,任务可恢复 |

---

## 快速开始

### 第一步: 安装和配置

#### 1. 安装依赖

```bash
pip install -r requirements.txt
```

#### 2. 配置API密钥

编辑 `.env.local` 文件:

```bash
OPENAI_API_KEY=sk-your-api-key-here
```

> ⚠️ **重要**: 请替换为你的实际OpenAI API Key

#### 3. 初始化数据库

```bash
python local_runner.py
```

看到 `✅ 数据库初始化完成` 即表示成功。

#### 4. 启动系统

**Windows用户**:
```bash
start_local.bat
```

**手动启动**:
```bash
streamlit run main.py
```

浏览器会自动打开 `http://localhost:8501`

### 第二步: 完成第一次批改

#### 1. 准备材料

需要三类文件:

1. **题目文件** - 包含完整题目
2. **答案文件** - 学生答卷(支持PDF/图片)
3. **评分标准** - 各题分值和扣分规则

**示例文件结构**:
```
test_data/
├── 三角形题目.txt
├── 学生答案_三角形.txt
└── 三角形评分标准.txt
```

#### 2. 上传文件

在Streamlit界面中:

1. 点击"上传题目文件"
2. 点击"上传答案文件"
3. 点击"上传评分标准"(可选)

#### 3. 选择批改模式

**高效模式** (推荐大规模批改):
- Token消耗: 500/题
- 输出: 简洁评分
- 适合: 50+份作业

**专业模式** (推荐小班教学):
- Token消耗: 1500/题
- 输出: 详细反馈+建议
- 适合: <30份作业

#### 4. 开始批改

点击"开始批改"按钮,系统会:

1. ✅ 验证文件
2. ✅ 提取学生信息
3. ✅ 解析评分标准
4. ✅ 检测题目
5. ✅ 并行批改
6. ✅ 生成报告

**进度条显示**:
```
正在批改... ▓▓▓▓▓░░░░░ 50%
```

#### 5. 查看结果

批改完成后,会显示:

- **总分**: 85/100
- **等级**: A
- **各题得分**: 表格形式
- **个人评价**: 优势、劣势、建议
- **班级分析**: (如果批改了多份)

---

## 基础功能

### 功能1: 文件上传

#### 支持的文件格式

| 类型 | 支持格式 |
|------|---------|
| 题目 | .txt, .pdf, .jpg, .png |
| 答案 | .txt, .pdf, .jpg, .png |
| 评分标准 | .txt, .pdf |

#### 上传技巧

✅ **文件命名规范**:
```
学生姓名_科目_题目类型.pdf
例如: 张三_数学_三角形.pdf
```

✅ **学生信息位置**:
- 建议在卷首标注: "姓名: 张三  学号: 20210001"
- 系统会自动识别

✅ **图片质量要求**:
- 分辨率: ≥1024px
- 格式: JPG/PNG
- 文字清晰可读

### 功能2: 批改模式选择

#### 高效模式 vs 专业模式

| 对比维度 | 高效模式 | 专业模式 |
|---------|---------|---------|
| Token消耗 | ~500/题 | ~1500/题 |
| 处理时间 | 2秒/题 | 5秒/题 |
| 反馈详细度 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 适用场景 | 大规模批改 | 小班精细批改 |
| 输出内容 | 分数+简评 | 分数+详细分析+建议 |

#### 高效模式输出示例

```json
{
  "qid": "Q1",
  "score": 8,
  "max_score": 10,
  "label": "correct",
  "brief_comment": "基本正确,第三步计算有误"
}
```

#### 专业模式输出示例

```json
{
  "qid": "Q1",
  "score": 8,
  "max_score": 10,
  "detailed_feedback": {
    "strengths": [
      "解题思路清晰,步骤完整",
      "公式运用正确"
    ],
    "weaknesses": [
      "第三步计算错误,导致最终答案错误",
      "未标注单位"
    ],
    "suggestions": [
      "加强运算准确性训练",
      "养成检查答案的习惯"
    ],
    "knowledge_points": [
      "三角函数恒等变换",
      "正弦定理应用"
    ]
  }
}
```

### 功能3: 学生信息识别

#### 自动识别字段

系统会尝试从答卷中提取:

- 姓名
- 学号
- 班级
- 作业编号

#### 识别规则

**精确匹配** (优先级1):
- 学号完全一致

**姓名+班级匹配** (优先级2):
- 姓名和班级同时匹配

**模糊匹配** (优先级3):
- 姓名相似度 ≥ 0.75
- 支持OCR识别错误纠正

**示例**:
```
OCR识别: "张彡" (错误)
数据库中: "张三"
相似度: 0.83
结果: 匹配成功 ✅
```

### 功能4: 评分标准解析

#### 标准格式

**推荐格式**:
```
第1题 (10分)
- 列出正弦定理公式 (3分)
- 代入已知条件 (2分)
- 计算正确 (3分)
- 结果单位标注 (2分)

扣分规则:
- 计算错误: -3分
- 漏写单位: -2分
```

#### 自动解析结果

系统会解析为JSON结构:

```json
{
  "Q1": {
    "max_score": 10,
    "score_items": [
      {"item": "列出公式", "score": 3},
      {"item": "代入条件", "score": 2},
      {"item": "计算正确", "score": 3},
      {"item": "单位标注", "score": 2}
    ],
    "deduction_rules": [
      {"trigger": "计算错误", "deduction": 3},
      {"trigger": "漏写单位", "deduction": 2}
    ]
  }
}
```

---

## 高级功能

### 功能1: 批次并行处理

#### 工作原理

系统会根据题目数量和模式,自动划分批次:

**高效模式**:
```
30题作业 → 3个批次(每批10题) → 3个Worker并行处理
处理时间: 30题 ÷ 3 × 2秒 = 20秒
```

**专业模式**:
```
30题作业 → 10个批次(每批3题) → 10个Worker并行处理
处理时间: 30题 ÷ 10 × 5秒 = 15秒
```

#### 性能监控

可以在日志中查看:

```
[INFO] 批次划分完成: 30题 → 3个批次
[INFO] Orchestrator生成3个Worker
[INFO] Worker 1: 处理Q1-Q10 (完成)
[INFO] Worker 2: 处理Q11-Q20 (完成)
[INFO] Worker 3: 处理Q21-Q30 (完成)
[INFO] 并行加速: 6.7x
```

#### 配置优化

调整并行数量:

```bash
# .env.local
MAX_PARALLEL_WORKERS=8  # 增加到8个Worker
```

### 功能2: 坐标标注

#### 功能说明

系统会在原卷上标记错误位置,输出像素坐标:

```json
{
  "annotations": [
    {
      "question_id": "Q1",
      "error_tokens": [
        {
          "text": "计算错误",
          "bbox": {"x": 120, "y": 350, "width": 80, "height": 30},
          "page": 1
        }
      ]
    }
  ]
}
```

#### 可视化展示

前端可以使用坐标在PDF/图片上绘制标记:

```python
# 伪代码
from PIL import Image, ImageDraw

img = Image.open("answer.jpg")
draw = ImageDraw.Draw(img)

for anno in annotations:
    bbox = anno['bbox']
    draw.rectangle(
        [(bbox['x'], bbox['y']), 
         (bbox['x']+bbox['width'], bbox['y']+bbox['height'])],
        outline='red',
        width=3
    )
```

### 功能3: 班级分析报告

#### 生成条件

当批改同一班级的多份作业时,系统会自动生成班级报告。

#### 报告内容

**1. 分数分布**:
```
90-100分: 15人 (30%)
80-89分:  20人 (40%)
70-79分:  10人 (20%)
60-69分:  5人  (10%)
<60分:    0人  (0%)
```

**2. 知识点掌握率**:
```
三角函数恒等变换: 85% (优秀)
正弦定理应用:     72% (良好)
余弦定理应用:     58% (需提高)
```

**3. 常见错误**:
- 计算错误 (25人)
- 公式混淆 (15人)
- 单位漏写 (10人)

**4. 教学建议**:
- 建议加强"余弦定理"专项练习
- 重点讲解"公式选择"策略
- 提醒学生注意单位标注

### 功能4: Checkpoint恢复

#### 功能说明

如果批改过程中断(网络、断电等),可以从中断点恢复:

```python
# 使用task_id恢复
task_id = "task_20250101_001"
workflow.resume(task_id)
```

#### 工作原理

系统会定期保存状态:

```
[INFO] Checkpoint保存: ingest_input (完成)
[INFO] Checkpoint保存: extract_via_mm (完成)
[INFO] Checkpoint保存: parse_rubric (完成)
[中断]
[INFO] 从Checkpoint恢复: parse_rubric
[INFO] 继续执行: detect_questions
```

---

## 最佳实践

### 1. 文件准备

✅ **DO**:
- 使用高质量扫描件(≥300dpi)
- 确保学生信息清晰可读
- 统一文件命名规范
- 按班级组织文件

❌ **DON'T**:
- 使用模糊、倾斜的照片
- 混淆多份作业在一个文件中
- 忽略评分标准文件
- 使用不支持的文件格式

### 2. 模式选择

✅ **高效模式适用场景**:
- 期中/期末大规模批改
- 日常作业快速批改
- Token预算有限
- 只需要分数和简评

✅ **专业模式适用场景**:
- 重点学生个性化辅导
- 小班教学详细反馈
- 需要生成学习建议
- 家长会展示用途

### 3. 性能优化

#### 提升批改速度

1. **增加并行Worker**:
```bash
MAX_PARALLEL_WORKERS=8
```

2. **使用高效模式**:
```python
mode = "efficient"
```

3. **优化批次阈值**:
```bash
EFFICIENT_MODE_THRESHOLD=8000  # 增大批次
```

#### 降低Token消耗

1. **优先使用高效模式**:
   - 可节省66% Token

2. **精简评分标准**:
   - 去除冗余描述
   - 只保留关键扣分点

3. **分批处理**:
   - 避免一次性批改过多作业

### 4. 质量控制

#### 定期检查

1. **抽查批改结果**:
   - 每批随机抽查5-10份
   - 对比人工批改结果

2. **调整提示词**:
   - 根据反馈优化Prompt
   - 记录版本变更

3. **监控准确率**:
   - 设置准确率目标(如85%)
   - 低于阈值时人工复查

#### 异常处理

1. **低置信度结果**:
```python
if evaluation['confidence'] < 0.6:
    # 标记为需人工复查
    evaluation['need_review'] = True
```

2. **学生信息缺失**:
   - 提示用户补充信息
   - 记录未匹配学生

3. **评分异常**:
   - 检测分数超出范围
   - 自动拦截并报警

---

## 常见问题

### Q1: 系统支持哪些学科?

**A**: 目前主要支持理科:
- ✅ 数学
- ✅ 物理
- ✅ 化学
- ⚠️ 英语、语文(部分支持)

### Q2: 批改准确率如何?

**A**: 
- 客观题(计算题): 90%+
- 主观题(证明题): 80%+
- 综合平均: 85%+

建议重要考试进行人工复查。

### Q3: 如何提高识别准确率?

**A**:
1. 使用高质量扫描件
2. 确保文字清晰可读
3. 在答卷上明确标注学生信息
4. 提供完整的评分标准

### Q4: Token消耗太大怎么办?

**A**:
1. 使用高效模式(节省66%)
2. 精简评分标准
3. 调整批次阈值
4. 考虑使用国产大模型

### Q5: 可以批改手写答卷吗?

**A**:
可以,但需要:
1. 高质量扫描(≥300dpi)
2. 字迹工整清晰
3. 可能需要OCR预处理

### Q6: 如何保护学生隐私?

**A**:
1. 数据存储在本地数据库
2. 不会将答卷上传至第三方
3. API调用遵循OpenAI隐私政策
4. 可以匿名化学生信息

### Q7: 支持导出报告吗?

**A**:
支持导出:
- ✅ JSON格式(程序调用)
- ✅ Markdown格式(文档)
- ✅ 班级分析Excel
- 🚧 PDF报告(开发中)

### Q8: 系统需要联网吗?

**A**:
- ✅ 需要网络访问OpenAI API
- ✅ 数据库可以本地SQLite
- ✅ 支持离线缓存评分标准

---

## 下一步

### 学习资源

1. **系统架构**: 阅读 [SYSTEM_ARCHITECTURE.md](./SYSTEM_ARCHITECTURE.md)
2. **API文档**: 查看 [API_REFERENCE.md](./API_REFERENCE.md)
3. **部署指南**: 参考 [DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md)
4. **故障排除**: 遇到问题查看 [TROUBLESHOOTING.md](./TROUBLESHOOTING.md)

### 进阶使用

1. **自定义提示词**: 修改 `functions/langgraph/prompts/`
2. **扩展Agent**: 添加自定义批改逻辑
3. **集成班级系统**: 配置API推送
4. **性能调优**: 优化并行和缓存策略

### 联系我们

- 📧 Email: support@aiguru.com
- 💬 GitHub Issues: [提交问题](https://github.com/aiguru/ai_correction/issues)
- 📖 文档中心: [在线文档](https://docs.aiguru.com)

---

**祝使用愉快! 🎉**
