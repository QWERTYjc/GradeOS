# LangGraph V2 批改系统设计文档

**版本**: v2.0  
**创建时间**: 2025-11-09  
**设计目标**: 提高批改精准度，改善输出质量

---

## 1. 核心改进

### 1.1 问题分析

**旧系统的问题**：
1. ❌ 评分标准解析不够细致 - 只提取了大类，没有提取细分评分点
2. ❌ 批改时没有充分利用评分标准 - LLM 批改时没有逐点对照
3. ❌ 输出内容太粗糙 - 只有总分和简单反馈，没有详细的评分细节
4. ❌ RubricInterpreter 和 QuestionGrader 协作不够 - 解析的评分标准没有被有效使用

**新系统的改进**：
1. ✅ **细分评分点提取** - RubricInterpreter 提取所有细分评分点（每个评分点都有明确的分值）
2. ✅ **逐点批改** - QuestionGrader 使用细分评分点逐一批改
3. ✅ **详细输出** - 每个评分点都有详细的分析、证据、得分原因
4. ✅ **紧密协作** - RubricInterpreter 的输出直接用于 QuestionGrader 的批改

---

## 2. Agent 架构

### 2.1 工作流程

```
┌─────────────────────────────────────────────────────────────┐
│                    LangGraph 批改工作流                      │
└─────────────────────────────────────────────────────────────┘

1. InputParserAgent
   ├─ 解析题目文件 → questions
   ├─ 解析答案文件 → answers
   └─ 解析评分标准文件 → marking_scheme (raw_text)

2. QuestionAnalyzerAgent
   ├─ 分析题型 → question_type
   ├─ 选择批改策略 → strategy
   └─ 提取关键词 → keywords

3. RubricInterpreterAgent ⭐ 核心改进
   ├─ 解析评分标准原文
   ├─ 提取细分评分点 → scoring_points[]
   │   ├─ point_id
   │   ├─ name
   │   ├─ description
   │   ├─ score (分值)
   │   ├─ keywords
   │   └─ criteria
   └─ 计算总分 → total_score

4. QuestionGraderAgent ⭐ 核心改进
   ├─ 获取细分评分点
   ├─ 构建详细批改提示词
   │   ├─ 包含所有评分点
   │   ├─ 要求逐点评分
   │   └─ 要求详细分析
   ├─ 调用 LLM 批改
   └─ 返回详细结果
       ├─ total_score
       ├─ scoring_details[] ⭐ 新增
       │   ├─ point_id
       │   ├─ point_name
       │   ├─ max_score
       │   ├─ score
       │   ├─ is_correct
       │   ├─ analysis
       │   ├─ evidence
       │   └─ reason
       ├─ overall_feedback
       ├─ strengths
       ├─ weaknesses
       └─ suggestions

5. ResultAggregatorAgent
   ├─ 聚合所有题目的批改结果
   ├─ 计算总分和得分率
   ├─ 生成总体评价
   └─ 识别薄弱知识点

6. DataPersistenceAgent
   └─ 保存批改结果到数据库（可选）
```

---

## 3. 数据结构

### 3.1 评分标准结构（RubricInterpreter 输出）

```python
marking_scheme = {
    'raw_text': '原始评分标准文本',
    'criteria': {
        'scoring_points': [
            {
                'id': 1,
                'name': '正确使用余弦定理',
                'description': '正确使用余弦定理 cosA = (b²+c²-a²)/(2bc) = c/(2b) = √5/2',
                'score': 2,  # 该评分点的分值
                'keywords': ['余弦定理', 'cosA', '(b²+c²-a²)/(2bc)'],
                'criteria': '正确使用余弦定理 cosA = (b²+c²-a²)/(2bc) = c/(2b) = √5/2'
            },
            {
                'id': 2,
                'name': '正确推导',
                'description': '正确推导 ±c² = b²-a²',
                'score': 1,
                'keywords': ['c²', 'b²-a²'],
                'criteria': '正确推导 ±c² = b²-a²'
            },
            # ... 更多评分点
        ],
        'total_score': 8  # 所有评分点的总分
    }
}
```

### 3.2 批改结果结构（QuestionGrader 输出）

```python
grading_result = {
    'question_id': 1,
    'student_id': 'unknown',
    'score': 1,  # 总得分
    'max_score': 8,  # 总满分
    'feedback': '总体评价',
    'scoring_details': [  # ⭐ 新增：详细的评分细节
        {
            'point_id': 1,
            'point_name': '正确使用余弦定理',
            'max_score': 2,
            'score': 1,  # 该评分点得分
            'is_correct': False,
            'analysis': '学生使用了余弦定理的公式 cosA = (b²+c²-a²)/(2bc)，这是正确的。但是，代入 A=π/2 后，cos(π/2) = 0，而不是 √5/2。学生在计算时出现了错误。',
            'evidence': 'cosA = (b²+c²-a²)/(2bc) = √5/2',
            'reason': '公式使用正确（1分），但计算结果错误（扣1分）'
        },
        {
            'point_id': 2,
            'point_name': '正确推导',
            'max_score': 1,
            'score': 1,
            'is_correct': True,
            'analysis': '学生正确写出了 c² = b²-a²，这与题目条件一致。',
            'evidence': 'c² = b²-a²',
            'reason': '完全正确'
        },
        # ... 更多评分点的详细信息
    ],
    'overall_feedback': '学生掌握了余弦定理的基本公式，但在特殊角的三角函数值计算上出现了错误。',
    'strengths': ['正确使用余弦定理公式', '正确推导 c² = b²-a²'],
    'weaknesses': ['cos(π/2) 的值计算错误'],
    'suggestions': ['复习特殊角的三角函数值，特别是 cos(π/2) = 0', '在代入公式后，仔细检查计算过程'],
    'strategy': 'semantic'
}
```

---

## 4. 提示词设计

### 4.1 评分标准解析提示词

**位置**: `ai_correction/prompts/grading_prompts.md` - 第1节

**关键点**：
- 提取所有细分评分点
- 每个评分点都有明确的分值
- 提取关键词和评分要求

### 4.2 逐题批改提示词

**位置**: `ai_correction/prompts/grading_prompts.md` - 第2节

**关键点**：
- 包含所有细分评分点
- 要求逐点评分
- 要求详细分析每个评分点
- 要求提供证据（引用学生答案原文）
- 要求说明得分/扣分原因

---

## 5. 输出格式优化

### 5.1 批改结果展示

**旧版输出**：
```
题目1: 1/10 分
反馈: 学生尝试使用了余弦定理...
```

**新版输出**：
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📝 题目 1：在△ABC中，内角A,B,C所对的边分别为a,b,c，已知A=π/2，b²-a²=c²/2。
          (1) 求tan C的值；(8分)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 总体成绩：1/8 分 (12.5%)

┌─────────────────────────────────────────────────────────────┐
│                        逐点评分详情                          │
└─────────────────────────────────────────────────────────────┘

✅ 评分点 1：正确使用余弦定理 (2分)
   得分：1/2 分
   
   📌 分析：
   学生使用了余弦定理的公式 cosA = (b²+c²-a²)/(2bc)，这是正确的。
   但是，代入 A=π/2 后，cos(π/2) = 0，而不是 √5/2。
   学生在计算时出现了错误。
   
   📄 证据：
   "cosA = (b²+c²-a²)/(2bc) = √5/2"
   
   💡 原因：
   公式使用正确（1分），但计算结果错误（扣1分）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 评分点 2：正确推导 ±c² = b²-a² (1分)
   得分：0/1 分
   
   📌 分析：
   学生写出了 c² = b²-a²，但题目条件是 b²-a²=c²/2，
   学生的推导不正确。
   
   📄 证据：
   "±c² = b²-a²"
   
   💡 原因：
   推导错误，与题目条件不符

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📝 总体评价：
学生掌握了余弦定理的基本公式，但在特殊角的三角函数值计算上出现了错误。
同时，对题目条件的理解和应用也存在问题。

💪 优点：
• 正确使用余弦定理公式
• 尝试进行推导

⚠️ 不足：
• cos(π/2) 的值计算错误
• 对题目条件 b²-a²=c²/2 的理解有误

🎯 改进建议：
• 复习特殊角的三角函数值，特别是 cos(π/2) = 0
• 在代入公式后，仔细检查计算过程
• 仔细阅读题目条件，确保正确理解和应用
```

---

## 6. 实现步骤

### 6.1 已完成
- [x] 创建提示词文档 (`prompts/grading_prompts.md`)
- [x] 保存旧提示词 (`prompts/legacy_prompts.md`)
- [x] 优化 RubricInterpreter 提取细分评分点
- [x] 优化 QuestionGrader 使用细分评分点批改

### 6.2 待完成
- [ ] 优化输出格式（production_integration.py）
- [ ] 测试新系统
- [ ] 对比新旧系统的批改结果
- [ ] 调整提示词以提高准确性

---

## 7. 预期效果

### 7.1 批改精准度提升

**旧系统**：
- 题目1: 1/10 分（实际应该是 1/8 分，因为满分是8分）
- 没有细分评分点的得分情况

**新系统**：
- 题目1: 1/8 分
- 评分点1: 1/2 分（公式正确，计算错误）
- 评分点2: 0/1 分（推导错误）
- 评分点3: 0/1 分（未完成）
- ... 每个评分点都有详细的分析

### 7.2 输出质量提升

**旧系统**：
- 简单的总分和反馈
- 没有详细的评分细节

**新系统**：
- 详细的逐点评分
- 每个评分点都有分析、证据、原因
- 美观的格式化输出
- 清晰的优点、不足、建议

---

**文档版本**: v2.0  
**最后更新**: 2025-11-09

