# AI批改系统部署指南

<cite>
**本文档引用的文件**
- [DEPLOYMENT_GUIDE.md](file://ai_correction/docs/DEPLOYMENT_GUIDE.md)
- [vercel.json](file://vercel.json)
- [start_local.bat](file://ai_correction/start_local.bat)
- [install_pdf_support.py](file://ai_correction/install_pdf_support.py)
- [requirements.txt](file://ai_correction/requirements.txt)
- [local_runner.py](file://ai_correction/local_runner.py)
- [main.py](file://ai_correction/main.py)
- [config.py](file://ai_correction/config.py)
- [urgent_fix_deployment.py](file://urgent_fix_deployment.py)
- [TROUBLESHOOTING.md](file://ai_correction/docs/TROUBLESHOOTING.md)
</cite>

## 目录
1. [项目概述](#项目概述)
2. [本地开发环境部署](#本地开发环境部署)
3. [生产环境部署方案](#生产环境部署方案)
4. [多模态支持配置](#多模态支持配置)
5. [部署验证与健康检查](#部署验证与健康检查)
6. [常见部署问题与解决方案](#常见部署问题与解决方案)
7. [紧急修复流程](#紧急修复流程)
8. [监控与维护](#监控与维护)

## 项目概述

AI批改系统是一个基于Streamlit的智能教育平台，支持多模态文件批改，包括文本、图片、PDF和Word文档。系统采用LangGraph架构，实现8个Agent的深度协作，提供高效的智能批改服务。

### 核心特性
- **多模态支持**：支持文本、图片、PDF、Word等多种文件格式
- **智能批改**：基于LLM的智能批改算法，支持高效和专业两种模式
- **分布式架构**：8个Agent协同工作，实现并行处理
- **云端部署**：支持Railway、Vercel等多种云平台部署

## 本地开发环境部署

### 环境准备

#### 1. 系统要求
- Python 3.9或更高版本
- Git版本控制系统
- 至少4GB可用内存
- 稳定的网络连接

#### 2. 克隆项目
```bash
git clone <repository-url>
cd ai_correction
```

#### 3. 安装依赖
```bash
pip install -r requirements.txt
```

#### 4. 环境变量配置

创建本地配置文件：
```bash
# 复制配置模板
copy .env.local .env

# 编辑配置文件
OPENAI_API_KEY=your-openai-api-key
DATABASE_URL=sqlite:///ai_correction.db
ENVIRONMENT=development
DEFAULT_MODE=professional
```

### 本地启动流程

#### 方法一：使用启动脚本
```bash
# Windows
start_local.bat

# Linux/macOS
chmod +x start_local.sh
./start_local.sh
```

#### 方法二：手动启动
```bash
# 1. 初始化数据库
python local_runner.py

# 2. 启动Streamlit应用
streamlit run main.py
```

### 本地环境验证

系统会自动执行以下检查：
- ✅ 依赖包完整性验证
- ✅ 数据库连接测试
- ✅ LLM API密钥有效性检查
- ✅ 工作流加载状态验证

**章节来源**
- [DEPLOYMENT_GUIDE.md](file://ai_correction/docs/DEPLOYMENT_GUIDE.md#L1-L50)
- [start_local.bat](file://ai_correction/start_local.bat#L1-L36)
- [local_runner.py](file://ai_correction/local_runner.py#L1-L205)

## 生产环境部署方案

### Railway部署（推荐）

#### 前置条件
- Railway账号
- GitHub仓库连接
- PostgreSQL数据库
- Redis缓存（可选）

#### 部署步骤

##### 1. 连接GitHub仓库
```bash
# 登录Railway
railway login

# 创建新项目并连接仓库
railway init
railway link
```

##### 2. 配置环境变量
```bash
# 数据库配置
DATABASE_URL=postgresql://user:password@host:5432/database

# LLM配置
OPENAI_API_KEY=sk-your-key
GEMINI_API_KEY=your-gemini-key

# 应用配置
ENVIRONMENT=production
DEFAULT_MODE=professional
MAX_PARALLEL_WORKERS=8
```

##### 3. 构建和启动配置
```bash
# 构建命令（Railway自动检测requirements.txt）
pip install -r requirements.txt

# 启动命令
streamlit run main.py --server.port=$PORT
```

##### 4. 数据库迁移
```bash
python functions/database/migration.py upgrade
```

### Vercel部署

#### 配置文件
Vercel部署需要以下配置：

```json
{
  "buildCommand": "pip install -r requirements.txt",
  "devCommand": "streamlit run main.py",
  "installCommand": "pip install -r requirements.txt"
}
```

#### vercel.json配置
```json
{
  "rewrites": [{"source": "/(.*)", "destination": "/index.html"}]
}
```

#### 部署流程
1. 连接到GitHub仓库
2. 配置环境变量
3. 设置构建和启动命令
4. 部署应用

### Docker部署

#### Dockerfile
```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

EXPOSE 8501

CMD ["streamlit", "run", "main.py", "--server.port=8501"]
```

#### docker-compose.yml
```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "8501:8501"
    environment:
      - DATABASE_URL=sqlite:///ai_correction.db
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./data:/app/data
```

**章节来源**
- [DEPLOYMENT_GUIDE.md](file://ai_correction/docs/DEPLOYMENT_GUIDE.md#L51-L150)
- [vercel.json](file://vercel.json#L1-L1)

## 多模态支持配置

### PDF处理支持

系统支持两种PDF处理模式：
1. **文本提取模式**：直接提取PDF文本内容
2. **图片模式**：将PDF转换为图片供Vision API处理

#### 安装PDF支持库
```bash
# 安装基本PDF支持
python ai_correction/install_pdf_support.py

# 手动安装（如果自动安装失败）
pip install PyPDF2 python-docx
```

#### PDF处理策略
```mermaid
flowchart TD
A["PDF文件输入"] --> B{"用户偏好"}
B --> |prefer_vision=True| C["图片模式"]
B --> |文本内容充足| D["文本提取"]
B --> |文本内容不足| C
D --> E{"文本长度 > 50字符?"}
E --> |是| F["返回文本内容"]
E --> |否| C
C --> G["转换为图片"]
G --> H["使用Vision API"]
F --> I["直接批改"]
H --> I
```

**图表来源**
- [install_pdf_support.py](file://ai_correction/install_pdf_support.py#L1-L29)
- [file_processor.py](file://ai_correction/functions/file_processor.py#L171-L253)

### 多模态文件处理架构

```mermaid
classDiagram
class MultiModalFile {
+string file_path
+string modality_type
+dict content_representation
+int page_count
+dict metadata
}
class PDFTextContent {
+string text
+int page_count
+string extraction_method
}
class PDFImageContent {
+list pages
+int page_count
+string conversion_method
}
class ImageContent {
+string base64_data
+string mime_type
+int width
+int height
}
class TextContent {
+string text
+string format
}
MultiModalFile --> PDFTextContent
MultiModalFile --> PDFImageContent
MultiModalFile --> ImageContent
MultiModalFile --> TextContent
```

**图表来源**
- [file_processor.py](file://ai_correction/functions/file_processor.py#L32-L74)

**章节来源**
- [install_pdf_support.py](file://ai_correction/install_pdf_support.py#L1-L29)
- [file_processor.py](file://ai_correction/functions/file_processor.py#L1-L280)

## 部署验证与健康检查

### 自动化验证流程

系统提供完整的部署验证工具：

#### 1. 本地运行器验证
```bash
python local_runner.py
```

验证项目包括：
- ✅ 依赖包完整性检查
- ✅ 数据库连接测试
- ✅ LLM API密钥验证
- ✅ 工作流加载状态
- ✅ 测试批改任务执行

#### 2. 端到端测试
```bash
# 运行测试批改任务
python local_runner.py --test-grading
```

#### 3. 性能基准测试
系统支持多种模式的性能测试：
- **高效模式**：节省66% token消耗
- **专业模式**：提供详细分析
- **批量模式**：支持大规模处理

### 健康检查指标

#### 关键监控指标
```mermaid
graph TB
A["健康检查"] --> B["API响应时间"]
A --> C["Token使用量"]
A --> D["并发处理数"]
A --> E["错误率"]
B --> B1["< 2秒"]
B --> B2["< 5秒"]
B --> B3["< 10秒"]
C --> C1["高效模式: ~500/题"]
C --> C2["专业模式: ~1500/题"]
D --> D1["≤ CPU核心数×2"]
E --> E1["< 1%"]
```

**图表来源**
- [local_runner.py](file://ai_correction/local_runner.py#L150-L204)

### 部署后验证清单

- [ ] ✅ 应用成功启动
- [ ] ✅ 数据库连接正常
- [ ] ✅ LLM API可用
- [ ] ✅ 文件上传功能正常
- [ ] ✅ 批改流程完整
- [ ] ✅ 历史记录功能正常
- [ ] ✅ 用户认证系统正常

**章节来源**
- [local_runner.py](file://ai_correction/local_runner.py#L150-L204)

## 常见部署问题与解决方案

### 依赖安装问题

#### 问题：pip install失败
**症状**：
```
ERROR: Could not find a version that satisfies the requirement...
```

**解决方案**：
```bash
# 使用国内镜像源
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 或升级pip
python -m pip install --upgrade pip
pip install -r requirements.txt
```

#### 问题：LangGraph导入错误
**症状**：
```
ModuleNotFoundError: No module named 'langgraph'
```

**解决方案**：
```bash
pip install langgraph>=0.0.40 langchain>=0.1.0
```

### 数据库连接问题

#### 问题：SQLite数据库损坏
**症状**：
```
sqlite3.DatabaseError: database disk image is malformed
```

**解决方案**：
```bash
# 删除并重建数据库
del ai_correction.db
python local_runner.py
```

#### 问题：PostgreSQL连接失败
**症状**：
```
psycopg2.OperationalError: could not connect to server
```

**解决方案**：
```bash
# 1. 检查连接字符串
echo $DATABASE_URL

# 2. 测试连接
python -c "from config.railway_postgres import get_railway_config; get_railway_config().test_connection()"

# 3. 检查防火墙和网络
```

### LLM API问题

#### 问题：OpenAI API认证失败
**症状**：
```
openai.error.AuthenticationError: Invalid API Key
```

**解决方案**：
```bash
# 检查API Key
echo $OPENAI_API_KEY

# 更新.env.local文件
OPENAI_API_KEY=sk-your-actual-key
```

#### 问题：Token限制超出
**症状**：
```
openai.error.RateLimitError: Rate limit exceeded
```

**解决方案**：
```bash
# 1. 使用高效模式
mode=efficient

# 2. 调整批次阈值
EFFICIENT_MODE_THRESHOLD=8000

# 3. 增加重试次数
MAX_RETRIES=5
```

### 性能优化问题

#### 问题：处理速度慢
**症状**：单题处理超过10秒

**解决方案**：
```bash
# 1. 使用高效模式
mode=efficient

# 2. 增加并行worker
MAX_PARALLEL_WORKERS=8

# 3. 检查网络延迟
# 使用国内API代理（如有）
```

#### 问题：内存占用高
**症状**：系统内存不足

**解决方案**：
```bash
# 1. 减少批次大小
PROFESSIONAL_MODE_THRESHOLD=3000

# 2. 限制并行任务
MAX_PARALLEL_WORKERS=4

# 3. 清理旧日志
del /q logs\*.log
```

**章节来源**
- [TROUBLESHOOTING.md](file://ai_correction/docs/TROUBLESHOOTING.md#L1-L316)

## 紧急修复流程

### 紧急修复脚本

当部署出现问题时，可以使用紧急修复脚本快速恢复：

#### 使用urgent_fix_deployment.py
```bash
python urgent_fix_deployment.py
```

该脚本执行以下操作：
1. ✅ 检查Railway连接状态
2. ✅ 清理失败的服务
3. ✅ 重新创建应用服务
4. ✅ 设置环境变量
5. ✅ 部署后端和前端服务
6. ✅ 最终状态检查

### 紧急修复流程图

```mermaid
flowchart TD
A["部署失败"] --> B["运行紧急修复脚本"]
B --> C["检查Railway状态"]
C --> D{"连接正常?"}
D --> |否| E["railway login"]
D --> |是| F["清理失败服务"]
E --> F
F --> G["重新链接项目"]
G --> H["创建后端服务"]
H --> I["设置环境变量"]
I --> J["部署后端"]
J --> K{"部署成功?"}
K --> |否| L["检查日志"]
K --> |是| M["创建前端服务"]
M --> N["部署前端"]
N --> O{"部署成功?"}
O --> |否| L
O --> |是| P["最终状态检查"]
L --> Q["人工干预"]
P --> R["部署完成"]
```

**图表来源**
- [urgent_fix_deployment.py](file://urgent_fix_deployment.py#L1-L112)

### 关键环境变量配置

部署完成后需要配置的关键环境变量：
- `OPENAI_API_KEY`：OpenAI API密钥
- `FIREBASE_PROJECT_ID`：Firebase项目ID
- `FIREBASE_CLIENT_EMAIL`：Firebase客户端邮箱
- `FIREBASE_PRIVATE_KEY`：Firebase私钥

**章节来源**
- [urgent_fix_deployment.py](file://urgent_fix_deployment.py#L1-L112)

## 监控与维护

### 日志管理系统

#### 日志配置
```bash
# 日志级别设置
LOG_LEVEL=INFO  # DEBUG, INFO, WARNING, ERROR

# 日志文件路径
LOG_FILE=logs/ai_correction.log
```

#### 日志查看命令
```bash
# 实时查看最新日志
tail -f logs/ai_correction.log

# 查看错误日志
grep ERROR logs/ai_correction.log

# 查看特定任务日志
grep "task_12345" logs/ai_correction.log
```

### 性能监控指标

#### 核心指标
| 指标类别 | 监控项目 | 正常范围 | 告警阈值 |
|----------|----------|----------|----------|
| 响应时间 | API响应时间 | < 2秒 | > 5秒 |
| Token消耗 | 单题Token使用量 | 500-1500 | > 2000 |
| 并发处理 | 同时处理任务数 | ≤ CPU核心数×2 | > CPU核心数×4 |
| 错误率 | API错误率 | < 1% | > 5% |
| 内存使用 | 内存占用 | < 80% | > 90% |

### 定期维护任务

#### 日常维护
```bash
# 1. 清理日志文件
find logs/ -name "*.log" -mtime +7 -delete

# 2. 数据库备份
cp ai_correction.db backups/

# 3. 更新依赖
pip install -r requirements.txt --upgrade
```

#### 周期性维护
```bash
# 1. 数据库优化
python -c "from functions.database.models import optimize_database(); optimize_database()"

# 2. 缓存清理
python -c "from functions.cache.manager import clear_cache(); clear_cache()"

# 3. 性能分析
python -c "from functions.performance.analyzer import analyze_performance(); analyze_performance()"
```

### 备份策略

#### 数据库备份
```bash
# SQLite备份
cp ai_correction.db ai_correction.db.backup

# PostgreSQL备份
pg_dump database_name > backup.sql
```

#### 恢复流程
```bash
# SQLite恢复
cp ai_correction.db.backup ai_correction.db

# PostgreSQL恢复
psql database_name < backup.sql
```

### 安全配置

#### API密钥管理
```bash
# 使用环境变量存储敏感信息
OPENAI_API_KEY=${OPENAI_API_KEY}

# 不要提交到Git
echo ".env" >> .gitignore
echo ".env.local" >> .gitignore
```

#### 数据库连接安全
```bash
# 使用连接池
DATABASE_POOL_SIZE=10
DATABASE_MAX_OVERFLOW=20
```

**章节来源**
- [config.py](file://ai_correction/config.py#L1-L83)
- [TROUBLESHOOTING.md](file://ai_correction/docs/TROUBLESHOOTING.md#L280-L316)

## 总结

本部署指南涵盖了从本地开发到生产环境的完整部署流程，包括：

1. **本地开发环境**：提供详细的环境配置和启动步骤
2. **生产环境部署**：支持Railway、Vercel、Docker等多种部署方案
3. **多模态支持**：详细说明PDF和Word文档的处理配置
4. **部署验证**：提供完整的健康检查和性能监控方案
5. **故障排除**：涵盖常见问题的诊断和解决方案
6. **紧急修复**：提供快速恢复部署的脚本和流程

通过遵循本指南，您可以成功部署AI批改系统，并确保其稳定运行。定期维护和监控将帮助您维持系统的高性能和可靠性。