# 本地部署指南

<cite>
**本文档引用的文件**
- [start_local.bat](file://ai_correction/start_local.bat)
- [local_runner.py](file://ai_correction/local_runner.py)
- [main.py](file://ai_correction/main.py)
- [requirements.txt](file://ai_correction/requirements.txt)
- [init_database.py](file://ai_correction/init_database.py)
- [config.py](file://ai_correction/config.py)
- [.env.local](file://ai_correction/.env.local)
- [DEPLOYMENT_GUIDE.md](file://ai_correction/docs/DEPLOYMENT_GUIDE.md)
- [ENVIRONMENT_VARIABLES.md](file://ai_correction/docs/ENVIRONMENT_VARIABLES.md)
- [TROUBLESHOOTING.md](file://ai_correction/docs/TROUBLESHOOTING.md)
- [QUICKSTART.md](file://ai_correction/docs/QUICKSTART.md)
</cite>

## 目录
1. [简介](#简介)
2. [系统要求](#系统要求)
3. [快速开始](#快速开始)
4. [使用start_local.bat脚本部署](#使用start_localbat脚本部署)
5. [手动部署步骤](#手动部署步骤)
6. [环境变量配置](#环境变量配置)
7. [常见问题解决方案](#常见问题解决方案)
8. [故障排除指南](#故障排除指南)
9. [性能优化建议](#性能优化建议)
10. [总结](#总结)

## 简介

AI智能批改系统是一个基于Streamlit的Web应用程序，支持多模态文件批改、智能评分和学生数据分析。本指南将详细介绍如何在本地环境中部署和运行该系统。

系统采用现代化的技术栈：
- **前端**: Streamlit框架
- **后端**: Python + LangGraph工作流
- **数据库**: SQLite/PostgreSQL
- **AI模型**: OpenAI/Gemini API

## 系统要求

### 硬件要求
- **最低配置**: 4GB内存，双核CPU
- **推荐配置**: 8GB内存，四核CPU
- **存储空间**: 至少2GB可用空间

### 软件要求
- **Python**: 3.9或更高版本
- **操作系统**: Windows 10+/macOS 10.15+/Linux
- **Git**: 用于代码克隆（可选）

### 网络要求
- 稳定的互联网连接
- 访问OpenAI API或其他LLM服务

## 快速开始

### 1. 克隆项目

```bash
git clone <repository-url>
cd ai_correction
```

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 配置API密钥

编辑 `.env.local` 文件：

```bash
# OpenAI API配置
OPENAI_API_KEY=sk-your-api-key-here

# 其他可选配置
# GEMINI_API_KEY=your-gemini-key
# DATABASE_URL=sqlite:///ai_correction.db
```

### 4. 初始化数据库

```bash
python local_runner.py
```

### 5. 启动应用

```bash
# 方法1: 使用Windows批处理脚本
start_local.bat

# 方法2: 手动启动
streamlit run main.py
```

浏览器将自动打开 `http://localhost:8501`

## 使用start_local.bat脚本部署

### 脚本工作流程

`start_local.bat` 是专门为Windows用户设计的一键启动脚本，它自动执行以下步骤：

```mermaid
flowchart TD
A["启动脚本"] --> B["激活虚拟环境"]
B --> C["设置环境变量"]
C --> D["运行环境检查"]
D --> E{"检查通过?"}
E --> |是| F["启动Streamlit应用"]
E --> |否| G["显示错误信息并暂停"]
F --> H["应用运行"]
G --> I["等待用户输入"]
```

**图表来源**
- [start_local.bat](file://ai_correction/start_local.bat#L1-L36)

### 脚本详细说明

#### 1. 虚拟环境激活
```batch
REM 激活虚拟环境（如果存在）
if exist venv\Scripts\activate.bat (
    echo 激活虚拟环境...
    call venv\Scripts\activate.bat
)
```
- 检查是否存在 `venv` 目录
- 自动激活Python虚拟环境
- 提供隔离的依赖环境

#### 2. 环境变量设置
```batch
REM 设置环境变量
set ENVIRONMENT=development
set DATABASE_URL=sqlite:///ai_correction.db
```
- `ENVIRONMENT=development`: 开发环境模式
- `DATABASE_URL=sqlite:///ai_correction.db`: 使用SQLite数据库

#### 3. 环境检查
```batch
echo 检查本地环境...
python local_runner.py
```
调用 `local_runner.py` 进行全面的环境检查

#### 4. 应用启动
```batch
if %errorlevel% equ 0 (
    echo 启动Streamlit应用...
    streamlit run main.py
) else (
    echo 环境检查失败！请查看错误信息
    pause
)
```
- 检查上一步的返回码
- 成功则启动Streamlit应用
- 失败则显示错误信息并暂停

**章节来源**
- [start_local.bat](file://ai_correction/start_local.bat#L1-L36)

## 手动部署步骤

### 1. 依赖安装

```bash
# 升级pip（可选）
python -m pip install --upgrade pip

# 安装所有依赖
pip install -r requirements.txt

# 或使用国内镜像源
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 2. 数据库初始化

```bash
# 方法1: 使用local_runner.py
python local_runner.py

# 方法2: 直接运行初始化脚本
python init_database.py
```

### 3. 环境变量配置

创建 `.env.local` 文件：

```bash
# 数据库配置
DATABASE_URL=sqlite:///ai_correction.db
DATABASE_TYPE=json  # 或 'postgresql', 'mysql'

# LLM配置
OPENAI_API_KEY=sk-your-api-key-here
OPENAI_API_BASE=https://api.openai.com/v1

# 运行环境
ENVIRONMENT=development
DEFAULT_MODE=professional

# 批次处理
EFFICIENT_MODE_THRESHOLD=6000
PROFESSIONAL_MODE_THRESHOLD=4000
MAX_PARALLEL_WORKERS=4

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=logs/ai_correction.log

# 其他配置
MAX_RETRIES=3
REQUEST_TIMEOUT=30
PUSH_ENABLED=false
```

### 4. 直接运行应用

```bash
# 启动Streamlit应用
streamlit run main.py

# 或指定端口
streamlit run main.py --server.port 8501
```

**章节来源**
- [local_runner.py](file://ai_correction/local_runner.py#L1-L205)
- [init_database.py](file://ai_correction/init_database.py#L1-L112)
- [config.py](file://ai_correction/config.py#L1-L83)

## 环境变量配置

### 核心配置项

#### 数据库配置
```bash
# SQLite（开发环境）
DATABASE_URL=sqlite:///ai_correction.db

# PostgreSQL（生产环境）
DATABASE_URL=postgresql://user:password@host:5432/dbname

# MySQL（可选）
DATABASE_URL=mysql://user:password@host:3306/dbname
```

#### LLM配置
```bash
# OpenAI配置
OPENAI_API_KEY=sk-your-api-key-here
OPENAI_API_BASE=https://api.openai.com/v1

# Gemini配置
GEMINI_API_KEY=AIzaSyxxxxxxxxxxxxxxxxx

# OpenRouter配置
OPENROUTER_API_KEY=sk-or-v1-xxxxxxxxxxxx
```

#### 运行环境配置
```bash
# 环境标识
ENVIRONMENT=development  # development, test, production

# 默认批改模式
DEFAULT_MODE=professional  # efficient, professional

# 批次处理阈值
EFFICIENT_MODE_THRESHOLD=6000
PROFESSIONAL_MODE_THRESHOLD=4000

# 并行处理配置
MAX_PARALLEL_WORKERS=4
```

### 配置文件层次

系统支持以下配置文件（按优先级排序）：
1. `.env.local` - 本地开发环境（不提交到git）
2. `.env.development` - 开发环境
3. `.env.test` - 测试环境
4. `.env.production` - 生产环境
5. `.env` - 默认配置

### 安全配置建议

```bash
# 1. 不要提交敏感信息到版本控制
echo ".env.local" >> .gitignore
echo ".env.production" >> .gitignore

# 2. 使用环境变量管理密钥
# 在Railway/Vercel中设置
OPENAI_API_KEY=${OPENAI_API_KEY}

# 3. 定期轮换API密钥
```

**章节来源**
- [ENVIRONMENT_VARIABLES.md](file://ai_correction/docs/ENVIRONMENT_VARIABLES.md#L1-L432)
- [config.py](file://ai_correction/config.py#L10-L83)

## 常见问题解决方案

### 1. 虚拟环境创建问题

#### 问题：虚拟环境创建失败
**症状**: `venv` 目录不存在或激活失败

**解决方案**:
```bash
# 创建新的虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows:
venv\Scripts\activate.bat
# macOS/Linux:
source venv/bin/activate
```

#### 问题：依赖安装冲突
**症状**: `pip install` 报错或版本冲突

**解决方案**:
```bash
# 清理pip缓存
pip cache purge

# 升级pip setuptools wheel
pip install --upgrade pip setuptools wheel

# 重新安装依赖
pip install -r requirements.txt
```

### 2. 数据库连接问题

#### 问题：SQLite数据库损坏
**症状**: `sqlite3.DatabaseError: database disk image is malformed`

**解决方案**:
```bash
# 删除并重建数据库
del ai_correction.db
python local_runner.py
```

#### 问题：数据库权限不足
**症状**: `Permission denied` 或 `Access denied`

**解决方案**:
```bash
# 检查文件权限
chmod 666 ai_correction.db

# 或修改数据库路径
DATABASE_URL=sqlite:///./ai_correction.db
```

### 3. API密钥问题

#### 问题：OpenAI API认证失败
**症状**: `openai.error.AuthenticationError: Invalid API Key`

**解决方案**:
```bash
# 检查API密钥
echo $OPENAI_API_KEY

# 更新配置文件
OPENAI_API_KEY=sk-your-actual-key
```

#### 问题：Token限制超出
**症状**: `openai.error.RateLimitError: Rate limit exceeded`

**解决方案**:
```bash
# 使用高效模式
DEFAULT_MODE=efficient

# 增大批次阈值
EFFICIENT_MODE_THRESHOLD=8000

# 增加重试次数
MAX_RETRIES=5
```

### 4. 端口占用问题

#### 问题：端口8501被占用
**症状**: `OSError: [Errno 48] Address already in use`

**解决方案**:
```bash
# 查找占用端口的进程
netstat -ano | findstr :8501

# 终止占用进程
taskkill /PID <PID> /F

# 或使用其他端口
streamlit run main.py --server.port 8502
```

### 5. 内存和性能问题

#### 问题：处理速度慢
**症状**: 单题处理超过10秒

**解决方案**:
```bash
# 使用高效模式
DEFAULT_MODE=efficient

# 增加并行worker
MAX_PARALLEL_WORKERS=8

# 优化批次大小
EFFICIENT_MODE_THRESHOLD=10000
```

#### 问题：内存占用过高
**症状**: 系统内存不足

**解决方案**:
```bash
# 减少批次大小
PROFESSIONAL_MODE_THRESHOLD=3000

# 限制并行任务
MAX_PARALLEL_WORKERS=4

# 清理旧日志
del /q logs\*.log
```

**章节来源**
- [TROUBLESHOOTING.md](file://ai_correction/docs/TROUBLESHOOTING.md#L1-L316)

## 故障排除指南

### 1. 环境检查流程

使用 `local_runner.py` 进行全面的环境检查：

```bash
python local_runner.py
```

该脚本会检查以下项目：
- ✅ 必需依赖包
- ✅ 环境变量设置
- ✅ API密钥有效性
- ✅ 数据库连接
- ✅ 工作流配置

### 2. 日志分析

#### 查看实时日志
```bash
# 最新日志
tail -f logs/ai_correction.log

# 错误日志
grep ERROR logs/ai_correction.log

# 特定任务日志
grep "task_12345" logs/ai_correction.log
```

#### 日志级别配置
```bash
# .env.local
LOG_LEVEL=DEBUG    # 详细调试
LOG_LEVEL=INFO     # 正常日志
LOG_LEVEL=WARNING  # 警告级别
LOG_LEVEL=ERROR    # 错误级别
```

### 3. 性能监控

#### Token消耗监控
```bash
# 高效模式：~500 tokens/题
# 专业模式：~1500 tokens/题
# 30题作业：15,000-45,000 tokens
```

#### 并行处理优化
```bash
# 根据CPU核心数调整
# 推荐：核心数 * 2
MAX_PARALLEL_WORKERS=8
```

### 4. 错误代码对照表

| 代码 | 含义 | 解决方案 |
|------|------|---------|
| E001 | API Key无效 | 检查OPENAI_API_KEY |
| E002 | 数据库连接失败 | 检查DATABASE_URL |
| E003 | 文件未找到 | 检查文件路径 |
| E004 | Token超限 | 使用高效模式 |
| E005 | 学生匹配失败 | 降低相似度阈值 |

### 5. 预防措施

#### 定期维护
```bash
# 清理日志
find logs/ -name "*.log" -mtime +7 -delete

# 数据库备份
cp ai_correction.db backups/

# 更新依赖
pip install -r requirements.txt --upgrade
```

#### 监控指标
- Token使用量
- API错误率
- 平均处理时间
- 数据库查询性能

**章节来源**
- [local_runner.py](file://ai_correction/local_runner.py#L150-L205)
- [TROUBLESHOOTING.md](file://ai_correction/docs/TROUBLESHOOTING.md#L200-L316)

## 性能优化建议

### 1. Token优化策略

#### 高效模式配置
```bash
# .env.local
DEFAULT_MODE=efficient              # 节省66% Token
EFFICIENT_MODE_THRESHOLD=8000       # 增大批次
```

#### 预期Token消耗
- 高效模式: ~500 tokens/题
- 专业模式: ~1500 tokens/题
- 30题作业: 15,000-45,000 tokens

### 2. 并行处理优化

```bash
# 根据硬件配置调整
MAX_PARALLEL_WORKERS=8          # 推荐值
EFFICIENT_MODE_THRESHOLD=6000   # 高效模式阈值
PROFESSIONAL_MODE_THRESHOLD=4000 # 专业模式阈值
```

### 3. 数据库优化

```bash
# SQLite优化（自动）
# 使用WAL模式

# PostgreSQL连接池配置
DATABASE_POOL_SIZE=10
DATABASE_MAX_OVERFLOW=20
```

### 4. 网络优化

```bash
# 使用国内API代理（如有）
OPENAI_API_BASE=https://your-proxy.com/v1

# 增加重试次数
MAX_RETRIES=5

# 增加超时时间
REQUEST_TIMEOUT=60
```

### 5. 系统资源优化

```bash
# 内存优化
MAX_PARALLEL_WORKERS=4          # 减少内存占用
PROFESSIONAL_MODE_THRESHOLD=3000 # 减小批次大小

# CPU优化
# 使用高效模式减少计算负担
DEFAULT_MODE=efficient
```

## 总结

本指南详细介绍了AI智能批改系统的本地部署流程，包括：

### 关键要点
1. **一键部署**: 使用 `start_local.bat` 脚本实现自动化部署
2. **手动部署**: 提供完整的手动部署步骤作为备用方案
3. **环境配置**: 详细说明环境变量配置和安全最佳实践
4. **问题解决**: 提供常见问题的诊断和解决方案
5. **性能优化**: 包含性能调优建议和监控指标

### 部署检查清单

- [ ] Python 3.9+ 已安装
- [ ] 依赖包已安装 (`pip install -r requirements.txt`)
- [ ] OpenAI API Key 已配置
- [ ] 数据库已初始化 (`python local_runner.py`)
- [ ] 系统启动成功 (`start_local.bat` 或 `streamlit run main.py`)
- [ ] 环境变量配置正确

### 下一步行动

1. **首次使用**: 按照快速入门指南进行第一次批改
2. **功能探索**: 查看完整使用指南了解高级功能
3. **生产部署**: 参考部署指南进行生产环境部署
4. **持续维护**: 定期更新和监控系统性能

遇到问题时，请参考故障排除指南或联系技术支持。祝您使用愉快！