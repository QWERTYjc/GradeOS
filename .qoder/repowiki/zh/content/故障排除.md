# AI批改系统故障排除指南

<cite>
**本文档引用的文件**
- [TROUBLESHOOTING.md](file://ai_correction/docs/TROUBLESHOOTING.md)
- [USER_GUIDE.md](file://ai_correction/docs/USER_GUIDE.md)
- [config.py](file://ai_correction/config.py)
- [main.py](file://ai_correction/main.py)
- [langgraph_integration.py](file://ai_correction/functions/langgraph_integration.py)
- [correction_service.py](file://ai_correction/functions/correction_service.py)
- [checkpointer.py](file://ai_correction/functions/langgraph/checkpointer.py)
- [routing.py](file://ai_correction/functions/langgraph/routing.py)
- [upload_validator.py](file://ai_correction/functions/langgraph/agents/upload_validator.py)
- [workflow.py](file://ai_correction/functions/langgraph/workflow.py)
- [test_integration.py](file://ai_correction/tests/test_integration.py)
- [result.md](file://ai_correction/test_data_debug/result.md)
- [001_张三_answers.txt](file://ai_correction/test_data/001_张三_answers.txt)
- [questions.txt](file://ai_correction/test_data/questions.txt)
- [ENVIRONMENT_VARIABLES.md](file://ai_correction/docs/ENVIRONMENT_VARIABLES.md)
</cite>

## 目录
1. [概述](#概述)
2. [系统架构概览](#系统架构概览)
3. [常见问题分类](#常见问题分类)
4. [文件上传问题](#文件上传问题)
5. [批改结果异常](#批改结果异常)
6. [性能瓶颈诊断](#性能瓶颈诊断)
7. [API调用错误](#api调用错误)
8. [工作流故障排除](#工作流故障排除)
9. [数据库问题](#数据库问题)
10. [日志分析与调试](#日志分析与调试)
11. [快速检查清单](#快速检查清单)
12. [预防措施](#预防措施)

## 概述

AI批改系统是一个基于LangGraph的智能批改平台，支持多模态文件处理、并行批改和智能分析。本指南提供了系统性的问题诊断和解决方案，帮助用户和开发者快速定位和解决各类故障。

### 系统特性
- ✅ **多模态支持**：PDF、图片、文本文件
- ✅ **双模式批改**：高效模式和专业模式
- ✅ **并行处理**：支持多任务并发
- ✅ **智能恢复**：Checkpoint机制支持任务恢复
- ✅ **实时监控**：完整的进度跟踪

## 系统架构概览

```mermaid
graph TB
subgraph "用户界面层"
UI[Streamlit前端]
Login[用户登录]
end
subgraph "业务逻辑层"
LangGraph[LangGraph工作流]
Agents[8个协作Agent]
Validator[文件验证器]
end
subgraph "数据处理层"
OCR[OCR处理]
Parser[内容解析]
Scorer[智能评分]
end
subgraph "存储层"
DB[(数据库)]
Cache[缓存系统]
Checkpoint[Checkpoint存储]
end
subgraph "外部服务"
LLM[LLM API]
Storage[文件存储]
end
UI --> LangGraph
Login --> LangGraph
LangGraph --> Agents
Agents --> Validator
Agents --> OCR
Agents --> Parser
Agents --> Scorer
Scorer --> DB
Scorer --> Cache
LangGraph --> Checkpoint
Scorer --> LLM
Validator --> Storage
```

**图表来源**
- [main.py](file://ai_correction/main.py#L1-L100)
- [workflow.py](file://ai_correction/functions/langgraph/workflow.py#L1-L100)

## 常见问题分类

### 问题分类体系

| 类别 | 子类别 | 描述 | 影响范围 |
|------|--------|------|----------|
| **文件处理** | 上传失败 | 文件格式不支持、大小超限 | 用户体验 |
| **批改结果** | 准确率低 | 评分标准不匹配、内容理解错误 | 批改质量 |
| **性能问题** | 处理缓慢 | Token消耗过高、并发限制 | 系统性能 |
| **系统故障** | 工作流中断 | Agent异常、Checkpoint失效 | 系统稳定性 |
| **配置问题** | 环境错误 | API密钥、数据库连接 | 系统可用性 |

## 文件上传问题

### 问题症状

#### 1. 文件格式不支持
**症状**：上传后显示"格式不支持"或文件无法识别

**可能原因**：
- 文件扩展名不在允许列表中
- 文件损坏或格式错误
- 文件编码问题

#### 2. 文件大小超限
**症状**：上传进度卡在90%，提示"文件过大"

**可能原因**：
- 单文件超过10MB限制
- 多文件总大小超限
- 内存不足

#### 3. 上传失败
**症状**：文件上传中断，无响应

**可能原因**：
- 网络连接不稳定
- 服务器资源不足
- 文件路径权限问题

### 解决步骤

#### 步骤1：验证文件格式
```bash
# 检查文件扩展名
ls -la uploads/test_user/*.pdf
file uploads/test_user/sample.pdf

# 验证文件完整性
head -n 10 uploads/test_user/sample.pdf
```

#### 步骤2：检查文件大小
```bash
# 查看文件大小
du -h uploads/test_user/sample.pdf

# 检查系统磁盘空间
df -h
```

#### 步骤3：验证文件权限
```bash
# 检查文件权限
ls -la uploads/test_user/

# 修复权限问题
chmod 644 uploads/test_user/sample.pdf
chown www-data:www-data uploads/test_user/
```

### 调试开关

启用详细日志记录：
```bash
# .env.local
LOG_LEVEL=DEBUG
```

**章节来源**
- [upload_validator.py](file://ai_correction/functions/langgraph/agents/upload_validator.py#L49-L86)
- [config.py](file://ai_correction/config.py#L40-L50)

## 批改结果异常

### 问题症状

#### 1. 评分结果不准确
**症状**：批改结果与预期差异较大

**可能原因**：
- 评分标准不清晰
- 学生答案理解错误
- LLM模型能力限制

#### 2. 部分题目未批改
**症状**：某些题目显示"未处理"或空白

**可能原因**：
- 题目格式不规范
- 内容过长导致Token超限
- Agent处理异常

#### 3. 坐标标注错误
**症状**：错误位置标记不准确

**可能原因**：
- OCR识别精度不足
- 图像质量差
- 坐标计算错误

### 解决步骤

#### 步骤1：检查评分标准
```bash
# 验证评分标准格式
cat test_data/评分标准.txt | head -n 20

# 检查评分点完整性
grep -E "(得分|扣分)" test_data/评分标准.txt
```

#### 步骤2：验证学生答案
```bash
# 检查答案文件编码
file test_data/学生答案.txt
iconv -f UTF-8 -t UTF-8 test_data/学生答案.txt -o test_data/学生答案_utf8.txt

# 验证答案内容
cat test_data/学生答案.txt | wc -l
```

#### 步骤3：切换批改模式
```bash
# 高效模式（快速但可能不准确）
mode=efficient

# 专业模式（详细但较慢）
mode=professional
```

### 调试数据示例

基于测试数据的调试分析：

**章节来源**
- [result.md](file://ai_correction/test_data_debug/result.md#L1-L50)
- [001_张三_answers.txt](file://ai_correction/test_data/001_张三_answers.txt#L1-L14)

## 性能瓶颈诊断

### 性能指标监控

#### 1. 处理速度分析
**正常范围**：
- 高效模式：2秒/题
- 专业模式：5秒/题

**异常情况**：
- 处理时间 > 10秒：可能存在性能问题
- Token消耗异常：检查模式设置

#### 2. 并发性能
**推荐配置**：
```bash
# 根据CPU核心数调整
MAX_PARALLEL_WORKERS=8

# 高效模式阈值
EFFICIENT_MODE_THRESHOLD=8000

# 专业模式阈值
PROFESSIONAL_MODE_THRESHOLD=5000
```

#### 3. 内存使用监控
**监控命令**：
```bash
# 查看内存使用
htop
free -h

# 监控Python进程
ps aux | grep python
```

### 性能优化策略

#### 优化1：调整批改模式
```bash
# 大规模批改使用高效模式
mode=efficient
EFFICIENT_MODE_THRESHOLD=8000

# 小规模精细批改使用专业模式
mode=professional
PROFESSIONAL_MODE_THRESHOLD=3000
```

#### 优化2：优化并发设置
```bash
# 根据硬件配置调整
MAX_PARALLEL_WORKERS=cpu_count * 2

# 避免过度并发
if cpu_count > 8:
    MAX_PARALLEL_WORKERS=8
```

#### 优化3：缓存策略
```bash
# 启用缓存
ENABLE_CACHE=true
CACHE_TTL=3600  # 1小时
```

**章节来源**
- [workflow.py](file://ai_correction/functions/langgraph/workflow.py#L150-L200)
- [ENVIRONMENT_VARIABLES.md](file://ai_correction/docs/ENVIRONMENT_VARIABLES.md#L184-L291)

## API调用错误

### 常见API错误

#### 1. 认证失败
**错误代码**：E001
**症状**：Invalid API Key

**解决方案**：
```bash
# 检查API密钥
echo $OPENAI_API_KEY

# 更新配置文件
OPENAI_API_KEY=sk-your-actual-key
```

#### 2. 请求超时
**错误代码**：E004
**症状**：请求超时或连接被拒绝

**解决方案**：
```bash
# 增加超时时间
REQUEST_TIMEOUT=60

# 使用国内代理
OPENAI_API_BASE=https://api.openai.com/v1
```

#### 3. Token限制
**错误代码**：Rate Limit Exceeded
**症状**：API调用频率过高

**解决方案**：
```bash
# 使用高效模式
mode=efficient

# 增加重试次数
MAX_RETRIES=5

# 调整批次阈值
EFFICIENT_MODE_THRESHOLD=6000
```

### API配置验证

#### 验证脚本
```python
import openai
import os

def validate_api():
    api_key = os.getenv('OPENAI_API_KEY')
    if not api_key:
        print("❌ API密钥未设置")
        return False
    
    try:
        client = openai.OpenAI(api_key=api_key)
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[{"role": "user", "content": "test"}],
            max_tokens=5
        )
        print("✅ API连接正常")
        return True
    except Exception as e:
        print(f"❌ API连接失败: {e}")
        return False
```

**章节来源**
- [TROUBLESHOOTING.md](file://ai_correction/docs/TROUBLESHOOTING.md#L30-L80)
- [config.py](file://ai_correction/config.py#L20-L40)

## 工作流故障排除

### 工作流状态监控

#### 1. Checkpoint机制
系统使用Checkpoint机制实现任务恢复：

```mermaid
sequenceDiagram
participant User as 用户
participant Workflow as 工作流
participant Checkpoint as Checkpoint存储
participant Agent as Agent
participant Recovery as 恢复机制
User->>Workflow : 提交批改任务
Workflow->>Agent : 执行批改步骤
Agent->>Checkpoint : 保存状态
Note over Agent,Checkpoint : 定期保存
Agent->>Agent : 执行批改
Agent-->>Workflow : 批改完成
Workflow-->>User : 返回结果
Note over User,Recovery : 系统中断
User->>Workflow : 重新提交任务
Workflow->>Checkpoint : 加载状态
Checkpoint-->>Workflow : 返回保存的状态
Workflow->>Agent : 从断点继续
Agent-->>Workflow : 继续批改
Workflow-->>User : 返回结果
```

**图表来源**
- [checkpointer.py](file://ai_correction/functions/langgraph/checkpointer.py#L102-L153)
- [routing.py](file://ai_correction/functions/langgraph/routing.py#L156-L191)

#### 2. Agent协作流程
```mermaid
flowchart TD
Start([开始批改]) --> Upload[文件上传验证]
Upload --> Route1{需要OCR?}
Route1 --> |是| OCR[OCR视觉处理]
Route1 --> |否| Text[文本处理]
OCR --> Rubric{有评分标准?}
Text --> Rubric
Rubric --> |是| Parse[解析评分标准]
Rubric --> |否| Score[直接评分]
Parse --> Score
Score --> Annot{需要标注?}
Annot --> |是| Build[构建坐标标注]
Annot --> |否| Mine[知识挖掘]
Build --> Mine
Mine --> Assemble[结果组装]
Assemble --> End([批改完成])
```

**图表来源**
- [workflow.py](file://ai_correction/functions/langgraph/workflow.py#L100-L150)

### 故障恢复策略

#### 检查点恢复
```bash
# 查看可用的Checkpoints
python -c "
from functions.langgraph.checkpointer import CheckpointManager
manager = CheckpointManager(None)
checkpoints = manager.list_checkpoints()
print('可用Checkpoints:', checkpoints)
"

# 删除特定任务的Checkpoint
python -c "
from functions.langgraph.checkpointer import CheckpointManager
manager = CheckpointManager(None)
manager.delete_checkpoint('task_20250101_001')
"
```

#### 错误处理路由
系统根据错误类型自动决定处理策略：

| 错误类型 | 处理策略 | 重试次数 | 超时时间 |
|----------|----------|----------|----------|
| 关键步骤失败 | 重试 | 3次 | 30秒 |
| 非关键错误 | 忽略继续 | 0次 | 10秒 |
| 网络超时 | 重试 | 5次 | 60秒 |
| API限制 | 重试 | 3次 | 120秒 |

**章节来源**
- [checkpointer.py](file://ai_correction/functions/langgraph/checkpointer.py#L150-L198)
- [routing.py](file://ai_correction/functions/langgraph/routing.py#L156-L191)

## 数据库问题

### 常见数据库错误

#### 1. SQLite数据库损坏
**症状**：sqlite3.DatabaseError: database disk image is malformed

**解决方案**：
```bash
# 删除并重建数据库
rm ai_correction.db
python local_runner.py
```

#### 2. PostgreSQL连接失败
**症状**：psycopg2.OperationalError: could not connect to server

**解决方案**：
```bash
# 1. 检查连接字符串
echo $DATABASE_URL

# 2. 测试连接
python -c "
from functions.database.models import check_database_connection
if check_database_connection():
    print('✅ 数据库连接正常')
else:
    print('❌ 数据库连接失败')
"
```

#### 3. 权限问题
**症状**：数据库写入失败

**解决方案**：
```bash
# 检查文件权限
ls -la ai_correction.db

# 修复权限
chmod 664 ai_correction.db
chown www-data:www-data ai_correction.db
```

### 数据库配置

#### SQLite配置
```bash
# 本地开发
DATABASE_URL=sqlite:///ai_correction.db
DATABASE_TYPE=json  # 本地JSON存储
```

#### PostgreSQL配置
```bash
# 生产环境
DATABASE_URL=postgresql://user:password@host:5432/dbname
DATABASE_POOL_SIZE=10
DATABASE_MAX_OVERFLOW=20
```

**章节来源**
- [TROUBLESHOOTING.md](file://ai_correction/docs/TROUBLESHOOTING.md#L40-L60)
- [config.py](file://ai_correction/config.py#L10-L30)

## 日志分析与调试

### 日志系统架构

```mermaid
graph LR
subgraph "日志级别"
DEBUG[DEBUG<br/>详细调试]
INFO[INFO<br/>关键步骤]
WARNING[WARNING<br/>警告信息]
ERROR[ERROR<br/>错误信息]
end
subgraph "日志输出"
Console[控制台输出]
File[文件日志]
Remote[远程日志]
end
subgraph "日志文件"
MainLog[ai_correction.log]
LocalLog[local_run.log]
ErrorLog[error.log]
end
DEBUG --> Console
INFO --> Console
INFO --> File
WARNING --> Console
WARNING --> File
ERROR --> Console
ERROR --> File
ERROR --> Remote
File --> MainLog
File --> LocalLog
File --> ErrorLog
```

### 日志级别配置

#### 环境变量设置
```bash
# 开发环境 - 详细日志
LOG_LEVEL=DEBUG

# 生产环境 - 警告及以上
LOG_LEVEL=WARNING

# 测试环境 - 信息级别
LOG_LEVEL=INFO
```

#### 日志查看命令
```bash
# 实时查看日志
tail -f logs/ai_correction.log

# 查看错误日志
grep ERROR logs/ai_correction.log

# 查看特定任务日志
grep "task_12345" logs/ai_correction.log

# 查看性能相关日志
grep -E "(time|duration|speed)" logs/ai_correction.log
```

### 关键调试信息

#### 1. 任务状态日志
```
[INFO] 任务状态更新: task_20250101_001
[INFO] 当前步骤: upload_validation
[INFO] 进度: 20%
[INFO] Token消耗: 1500
```

#### 2. 错误堆栈信息
```
[ERROR] 文件验证失败: FileNotFoundError
[ERROR] Traceback (most recent call last):
[ERROR]   File "...", line 123, in _validate_files
[ERROR]     with open(file_path, 'r') as f:
[ERROR] FileNotFoundError: [Errno 2] No such file or directory
```

#### 3. 性能指标
```
[INFO] 批次处理完成: 30题 → 3个批次
[INFO] 并行加速: 6.7x
[INFO] 平均处理时间: 2.5秒/题
[INFO] Token消耗: 500/题
```

### 调试开关启用

#### 详细日志模式
```bash
# 启用详细日志
export LOG_LEVEL=DEBUG

# 设置日志文件
export LOG_FILE=logs/debug.log
```

#### 性能监控
```bash
# 启用性能监控
export ENABLE_PERFORMANCE_MONITORING=true

# 设置采样率
export PERFORMANCE_SAMPLING_RATE=0.1
```

**章节来源**
- [config.py](file://ai_correction/config.py#L60-L70)
- [TROUBLESHOOTING.md](file://ai_correction/docs/TROUBLESHOOTING.md#L280-L315)

## 快速检查清单

### 启动前检查

#### ✅ 基础环境
- [ ] Python版本 >= 3.8
- [ ] pip包安装完成
- [ ] .env.local配置正确
- [ ] 数据库连接正常

#### ✅ API配置
- [ ] OPENAI_API_KEY已设置
- [ ] API密钥有效
- [ ] 网络连接正常
- [ ] 代理设置正确

#### ✅ 文件系统
- [ ] uploads目录可写
- [ ] 日志目录存在
- [ ] 文件权限正确
- [ ] 磁盘空间充足

### 运行时检查

#### ✅ 系统状态
- [ ] Streamlit服务运行
- [ ] LangGraph工作流正常
- [ ] Agent协作正常
- [ ] Checkpoint机制工作

#### ✅ 性能指标
- [ ] 处理速度正常
- [ ] 内存使用合理
- [ ] CPU负载正常
- [ ] 网络延迟可接受

#### ✅ 数据质量
- [ ] 文件格式正确
- [ ] 内容可读
- [ ] 评分标准完整
- [ ] 学生答案清晰

### 故障后检查

#### ✅ 错误诊断
- [ ] 查看错误日志
- [ ] 检查系统资源
- [ ] 验证配置文件
- [ ] 测试API连接

#### ✅ 恢复验证
- [ ] 重启服务
- [ ] 清理缓存
- [ ] 重置状态
- [ ] 验证功能

## 预防措施

### 定期维护

#### 1. 日志清理
```bash
# 清理旧日志（保留7天内）
find logs/ -name "*.log" -mtime +7 -delete

# 压缩历史日志
gzip logs/*.log
```

#### 2. 数据库维护
```bash
# SQLite优化
python -c "
import sqlite3
conn = sqlite3.connect('ai_correction.db')
conn.execute('VACUUM')
conn.execute('ANALYZE')
conn.close()
"

# PostgreSQL优化
# \VACUUM ANALYZE;
```

#### 3. 依赖更新
```bash
# 更新Python包
pip install -r requirements.txt --upgrade

# 检查安全漏洞
pip-audit
```

### 监控指标

#### 系统健康指标
- ✅ **响应时间**：< 5秒
- ✅ **错误率**：< 1%
- ✅ **可用性**：> 99%
- ✅ **吞吐量**：> 10任务/分钟

#### 业务指标
- ✅ **批改准确率**：> 85%
- ✅ **Token效率**：> 70%
- ✅ **并发处理**：> 5任务
- ✅ **恢复成功率**：> 95%

### 最佳实践

#### 1. 配置管理
```bash
# 使用环境变量
export ENVIRONMENT=production
export DATABASE_URL=postgresql://...

# 避免硬编码敏感信息
# ❌ 不推荐
API_KEY = "sk-xxx"

# ✅ 推荐
API_KEY = os.getenv("OPENAI_API_KEY")
```

#### 2. 错误处理
```python
# 实现优雅降级
try:
    result = expensive_operation()
except Exception as e:
    logger.warning(f"操作失败，使用备用方案: {e}")
    result = fallback_operation()
```

#### 3. 性能优化
```python
# 使用异步处理
async def batch_process(files):
    tasks = [process_file(f) for f in files]
    results = await asyncio.gather(*tasks)
    return results

# 实现智能缓存
@lru_cache(maxsize=100)
def get_cached_result(key):
    return expensive_calculation(key)
```

#### 4. 监控告警
```bash
# 设置系统监控
watch -n 60 "python monitor_system_health.py"

# 邮件通知
if [ $? -ne 0 ]; then
    echo "系统故障，请检查" | mail -s "AI批改系统告警" admin@example.com
fi
```

**章节来源**
- [TROUBLESHOOTING.md](file://ai_correction/docs/TROUBLESHOOTING.md#L300-L315)
- [ENVIRONMENT_VARIABLES.md](file://ai_correction/docs/ENVIRONMENT_VARIABLES.md#L292-L378)

## 结论

本故障排除指南涵盖了AI批改系统的主要问题类型和解决方案。通过系统性的诊断方法和预防措施，可以显著提高系统的稳定性和用户体验。

### 关键要点
1. **系统性思维**：从用户界面到底层数据库的完整链路分析
2. **分层诊断**：按文件处理、业务逻辑、系统服务分层排查
3. **预防为主**：建立完善的监控和维护机制
4. **持续优化**：根据使用反馈不断改进系统

### 下一步行动
- 定期检查系统健康状况
- 建立标准化的故障处理流程
- 收集用户反馈并优化系统
- 持续监控性能指标

通过遵循本指南的最佳实践，可以确保AI批改系统稳定、高效地运行，为用户提供优质的智能批改服务。