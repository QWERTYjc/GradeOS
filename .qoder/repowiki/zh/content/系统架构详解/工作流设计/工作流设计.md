现在我有了足够的信息来创建全面的工作流设计文档。让我生成完整的文档：

<docs>
# 多模态批改工作流设计文档

<cite>
**本文档引用的文件**
- [workflow_multimodal.py](file://ai_correction/functions/langgraph/workflow_multimodal.py)
- [state.py](file://ai_correction/functions/langgraph/state.py)
- [checkpointer.py](file://ai_correction/functions/langgraph/checkpointer.py)
- [streaming.py](file://ai_correction/functions/langgraph/streaming.py)
- [multimodal_models.py](file://ai_correction/functions/langgraph/multimodal_models.py)
- [orchestrator_agent.py](file://ai_correction/functions/langgraph/agents/orchestrator_agent.py)
- [batch_planning_agent.py](file://ai_correction/functions/langgraph/agents/batch_planning_agent.py)
- [grading_worker_agent.py](file://ai_correction/functions/langgraph/agents/grading_worker_agent.py)
- [result_aggregator_agent.py](file://ai_correction/functions/langgraph/agents/result_aggregator_agent.py)
- [class_analysis_agent.py](file://ai_correction/functions/langgraph/agents/class_analysis_agent.py)
- [test_multimodal_grading.py](file://ai_correction/test_multimodal_grading.py)
</cite>

## 目录
1. [概述](#概述)
2. [系统架构](#系统架构)
3. [核心组件分析](#核心组件分析)
4. [工作流执行流程](#工作流执行流程)
5. [状态管理系统](#状态管理系统)
6. [检查点与恢复机制](#检查点与恢复机制)
7. [流式执行与进度监控](#流式执行与进度监控)
8. [单例模式实现](#单例模式实现)
9. [调试与扩展指南](#调试与扩展指南)
10. [最佳实践](#最佳实践)

## 概述

多模态批改工作流是一个基于LangGraph状态机的复杂AI批改系统，采用深度协作的8个Agent架构，实现了从多模态文件输入到最终结果输出的完整批改流程。该系统的核心特性包括：

- **深度协作架构**：8个专门Agent协同工作，每个Agent负责特定的功能模块
- **多模态处理能力**：支持文本、图片、PDF等多种文件格式的统一处理
- **批次并行处理**：基于学生数量智能规划批次，实现高效的并行批改
- **Token极致优化**：通过压缩包机制减少重复计算，优化LLM调用成本
- **流式执行监控**：实时跟踪执行进度，支持断点续传和错误恢复

## 系统架构

### 整体架构图

```mermaid
graph TB
subgraph "工作流入口"
A[orchestrator<br/>任务编排]
end
subgraph "多模态输入处理"
B[multimodal_input<br/>多模态文件处理]
C[question_understanding<br/>题目理解]
D[answer_understanding<br/>答案理解]
E[rubric_interpretation<br/>评分标准解析]
end
subgraph "学生与批次管理"
F[student_detection<br/>学生信息识别]
G[batch_planning<br/>批次规划]
end
subgraph "压缩包生成"
H[rubric_master<br/>评分标准主控]
I[question_context<br/>题目上下文]
end
subgraph "批改执行"
J[grading_worker<br/>批改工作]
end
subgraph "结果处理"
K[result_aggregator<br/>结果聚合]
L[class_analysis<br/>班级分析]
end
subgraph "最终处理"
M[finalize<br/>结果最终化]
end
A --> B
B --> C
B --> D
B --> E
C --> F
D --> F
E --> F
F --> G
G --> H
G --> I
H --> J
I --> J
J --> K
K --> L
L --> M
M --> END
```

**图表来源**
- [workflow_multimodal.py](file://ai_correction/functions/langgraph/workflow_multimodal.py#L39-L74)

### Agent协作关系图

```mermaid
classDiagram
class MultiModalGradingWorkflow {
+StateGraph graph
+MemorySaver checkpointer
+__init__()
+_build_workflow()
+execute(initial_state) GradingState
+_finalize_results(state) GradingState
}
class OrchestratorAgent {
+__call__(state) Dict
+_analyze_task_type(state) str
+_calculate_optimal_batch_size(state) int
}
class BatchPlanningAgent {
+__call__(state) Dict
+_plan_batches(students_info) List
}
class GradingWorkerAgent {
+__call__(state) Dict
+_grade_student(student, rubric, context) Dict
}
class ResultAggregatorAgent {
+__call__(state) Dict
+_generate_student_report(result) Dict
+_calculate_grade_level(score, state) str
}
class ClassAnalysisAgent {
+__call__(state) Dict
+_calculate_distribution(scores) Dict
+_identify_common_issues(results) List
}
MultiModalGradingWorkflow --> OrchestratorAgent
MultiModalGradingWorkflow --> BatchPlanningAgent
MultiModalGradingWorkflow --> GradingWorkerAgent
MultiModalGradingWorkflow --> ResultAggregatorAgent
MultiModalGradingWorkflow --> ClassAnalysisAgent
```

**图表来源**
- [workflow_multimodal.py](file://ai_correction/functions/langgraph/workflow_multimodal.py#L39-L74)
- [orchestrator_agent.py](file://ai_correction/functions/langgraph/agents/orchestrator_agent.py#L15-L130)
- [batch_planning_agent.py](file://ai_correction/functions