# 文件上传处理

<cite>
**本文档引用文件**  
- [main.py](file://ai_correction/main.py)
- [config.py](file://ai_correction/config.py)
- [upload_validator.py](file://ai_correction/functions/langgraph/agents/upload_validator.py)
- [UI_OPTIMIZATION_SUMMARY.md](file://ai_correction/docs/UI_OPTIMIZATION_SUMMARY.md)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档详细描述了AI批改系统中的文件上传处理机制，重点介绍Streamlit中文件上传的实现方式。文档涵盖了`save_files`函数如何根据用户名创建隔离的用户目录，生成带有时间戳和安全文件名的存储路径，以及支持的文件类型和大小限制的实现机制。同时结合UI优化策略，说明文件上传区域如何集成到批改流程中，并描述多文件上传后的预览机制。

## 项目结构
系统采用模块化设计，文件上传功能主要分布在核心模块中。上传文件存储在根目录下的`uploads`文件夹中，每个用户有独立的子目录。配置文件`config.py`和主应用文件`main.py`共同管理文件上传的核心逻辑。

```mermaid
graph TD
A[根目录] --> B[uploads]
A --> C[ai_correction]
C --> D[main.py]
C --> E[config.py]
C --> F[functions/langgraph/agents/upload_validator.py]
C --> G[docs/UI_OPTIMIZATION_SUMMARY.md]
B --> H[test_user_1]
B --> I[testuser]
```

**图示来源**  
- [main.py](file://ai_correction/main.py#L81-L133)
- [config.py](file://ai_correction/config.py#L48-L80)

**本节来源**  
- [main.py](file://ai_correction/main.py#L81-L133)
- [config.py](file://ai_correction/config.py#L48-L80)

## 核心组件
文件上传处理机制由多个核心组件构成，包括文件存储、格式验证、大小限制和用户隔离等功能。`save_files`函数负责将上传的文件安全地存储到用户专属目录中，`ALLOWED_EXTENSIONS`常量定义了支持的文件类型，`MAX_FILE_SIZE`常量设置了文件大小限制。

**本节来源**  
- [main.py](file://ai_correction/main.py#L423-L466)
- [config.py](file://ai_correction/config.py#L48-L80)

## 架构概述
文件上传处理采用分层架构设计，从用户界面到文件存储形成完整的处理链条。系统首先在Streamlit界面接收用户上传的文件，然后通过验证机制检查文件类型和大小，最后将合格的文件存储到基于用户名隔离的目录结构中。

```mermaid
graph LR
A[用户界面] --> B[文件上传]
B --> C[格式验证]
C --> D[大小验证]
D --> E[用户目录创建]
E --> F[文件存储]
F --> G[预览机制]
G --> H[批改流程]
```

**图示来源**  
- [main.py](file://ai_correction/main.py#L423-L466)
- [UI_OPTIMIZATION_SUMMARY.md](file://ai_correction/docs/UI_OPTIMIZATION_SUMMARY.md#L0-L389)

## 详细组件分析

### 文件存储机制分析
系统通过`save_files`函数实现安全的文件存储机制，为每个用户创建隔离的目录，并生成带有时间戳的唯一文件名。

#### 文件存储流程
```mermaid
flowchart TD
Start([开始]) --> CreateUserDir["创建用户目录<br/>UPLOAD_DIR / username"]
CreateUserDir --> CheckFile["遍历上传文件"]
CheckFile --> ExtractInfo["提取文件信息<br/>时间戳、扩展名、安全文件名"]
ExtractInfo --> GenerateName["生成存储文件名<br/>{timestamp}_{safe_name}{ext}"]
GenerateName --> SaveFile["保存文件到用户目录"]
SaveFile --> AddPath["将路径添加到saved_paths"]
AddPath --> NextFile{"还有更多文件?"}
NextFile --> |是| CheckFile
NextFile --> |否| ReturnPaths["返回存储路径列表"]
ReturnPaths --> End([结束])
```

**图示来源**  
- [main.py](file://ai_correction/main.py#L423-L466)

**本节来源**  
- [main.py](file://ai_correction/main.py#L423-L466)

### 文件验证机制分析
系统通过`upload_validator.py`中的验证器类实现全面的文件验证机制，确保上传文件的质量和安全性。

#### 图像文件验证流程
```mermaid
sequenceDiagram
participant Validator as UploadValidator
participant Image as Image.open()
participant Logger as Logger
Validator->>Image : 打开图像文件
Image-->>Validator : 返回图像对象
Validator->>Validator : 检查图像尺寸
alt 尺寸过大
Validator->>Logger : 记录警告日志
Validator-->>Validator : 返回False
else 尺寸正常
Validator->>Validator : 检查图像模式
alt 模式不支持
Validator->>Logger : 记录警告日志
Validator-->>Validator : 返回False
else 模式支持
Validator-->>Validator : 返回True
end
end
```

**图示来源**  
- [upload_validator.py](file://ai_correction/functions/langgraph/agents/upload_validator.py#L119-L153)

**本节来源**  
- [upload_validator.py](file://ai_correction/functions/langgraph/agents/upload_validator.py#L119-L153)

### 预览机制分析
系统实现了多文件类型的预览机制，支持图像、文本和PDF文件的可视化展示，与批改流程无缝集成。

#### 文件预览流程
```mermaid
flowchart TD
A[开始预览] --> B{文件类型}
B --> |图像| C[转换为base64编码]
C --> D[使用HTML/CSS创建固定高度容器]
D --> E[嵌入base64图像数据]
E --> F[显示预览]
B --> |文本| G[读取文件内容]
G --> H{内容长度>5000?}
H --> |是| I[截断内容并添加提示]
H --> |否| J[完整显示内容]
I --> K[使用text_area显示]
J --> K
B --> |PDF| L[显示PDF信息提示]
B --> |其他| M[显示不支持预览提示]
K --> F
L --> F
M --> F
F --> N[结束]
```

**图示来源**  
- [main.py](file://ai_correction/main.py#L691-L759)
- [UI_OPTIMIZATION_SUMMARY.md](file://ai_correction/docs/UI_OPTIMIZATION_SUMMARY.md#L0-L389)

**本节来源**  
- [main.py](file://ai_correction/main.py#L691-L759)
- [UI_OPTIMIZATION_SUMMARY.md](file://ai_correction/docs/UI_OPTIMIZATION_SUMMARY.md#L0-L389)

## 依赖分析
文件上传处理机制依赖于多个外部库和系统组件，形成完整的功能链条。

```mermaid
graph TD
A[Streamlit] --> B[文件上传界面]
B --> C[Pathlib] --> D[文件路径处理]
C --> E[目录创建]
D --> F[文件名提取]
F --> G[安全文件名生成]
G --> H[re模块]
H --> I[特殊字符替换]
I --> J[文件存储]
J --> K[built-in open()]
K --> L[二进制写入]
L --> M[用户隔离目录]
M --> N[UPLOAD_DIR]
N --> O[config.py]
O --> P[常量定义]
P --> Q[ALLOWED_EXTENSIONS]
P --> R[MAX_FILE_SIZE]
```

**图示来源**  
- [main.py](file://ai_correction/main.py#L423-L466)
- [config.py](file://ai_correction/config.py#L48-L80)

**本节来源**  
- [main.py](file://ai_correction/main.py#L423-L466)
- [config.py](file://ai_correction/config.py#L48-L80)

## 性能考虑
文件上传处理机制在设计时充分考虑了性能因素，通过多种优化策略确保系统的高效运行。

- **目录隔离**: 为每个用户创建独立的目录，避免文件名冲突和权限问题
- **时间戳命名**: 使用精确到秒的时间戳作为文件名前缀，确保文件名的唯一性
- **安全文件名**: 通过正则表达式替换特殊字符，防止路径遍历攻击
- **固定高度预览**: 为所有文件预览区域设置固定高度（500px），确保界面布局的一致性
- **内容截断**: 对超过5000字符的文本文件进行截断显示，避免内存溢出
- **base64优化**: 对图像文件使用base64编码预览，避免多次文件读取

## 故障排除指南
当文件上传或预览出现问题时，可参考以下常见问题及解决方案：

**本节来源**  
- [main.py](file://ai_correction/main.py#L782-L807)
- [upload_validator.py](file://ai_correction/functions/langgraph/agents/upload_validator.py#L119-L153)

## 结论
AI批改系统的文件上传处理机制设计完善，通过用户目录隔离、安全文件名生成、严格的格式和大小验证，确保了文件处理的安全性和可靠性。系统支持多种文件类型的预览，与批改流程无缝集成，为用户提供直观的交互体验。未来可进一步优化图像质量检测算法，增加更多文件类型的预览支持，并实现更智能的文件分类和管理功能。