<!-- 720981c1-72aa-4282-9143-84fa075718ff 999544f2-e332-452a-aacb-6fddb6702c29 -->
# 方案：基于题号范围与智能批次的多模态批改增强

## 1. 前端输入与参数传递

- 在 `main.py` 的批改设置区域新增题号范围输入框，接受逗号+区间混合（例如 `3,5-8,12`）。
- 引入解析提示、格式校验与错误反馈（如非法字符、结束值小于起始值）。
- 将解析结果（题目 ID 列表或空表示整卷）存入 `st.session_state` 并传入 `run_multimodal_grading`。

## 2. 题号范围解析与状态扩展

- 新增 `utils/question_scope.py`（或类似位置）提供 `parse_question_scope(scope_str: str) -> List[str]`，支持逗号分隔、区间 `start-end`、去重、排序、自动加 `Q` 前缀。
- 返回完整题号列表与原始字符串，用于日志与错误提示。
- 在 `functions/langgraph/workflow_multimodal.py` 的初始 `GradingState` 中添加 `target_questions`, `scope_description` 字段，默认空列表（表示整卷）。

## 3. 批次规划与Rubric处理调整

- 修改 `agents/batch_planning_agent.py`：
- 默认“一名学生=一个批次”，当无法识别学生信息时以 25 张图片为上限自动切分批次。
- 实现重复批改检测（如基于答案文本/图像指纹哈希与题号组合），若同一题被检测为再次批改且题目一致，则判定为下一位学生，并为未命名学生自动命名 Student A/B/C…
- 若设置了 `target_questions`，将批次元数据中标记允许题号，供后续Agent引用。
- 更新 `agents/rubric_master_agent.py`：
- 保留对整份评分标准的深度理解，但新增 `target_questions` 过滤视图，仅把目标题号的评分点同步到批次包。
- 强化输出结构：为每题生成“可做/不可做/常见误区/另类解法”字段，提醒避免重复计分。

## 4. 问题上下文与批改逻辑

- 修改 `question_context_agent.py`，生成全题上下文，但在批次包内附带 `target_questions` 的过滤快照，供批改引用。
- 调整 `grading_worker_agent.py`：
- 逐学生批次批改，先检查 `target_questions`，只针对允许题号构建提示与解析。
- 若答案内容不在范围内，跳过并在结果中记录 `status: skipped`。
- 针对同一题的多个评分点，基于新的 rubric 元信息防止重复加分（如按 `criterion_id` 去重或在解析后统一合并）。

## 5. 结果聚合与输出

- 更新 `result_aggregator_agent.py` 与 `_finalize_results`：
- 只计算目标题号的总分/百分比；未指定题目的评分点忽略。
- 输出 JSON 结构中明确列出 `graded_questions`、`skipped_questions`、`scope_description`、`student_alias_map`（如 Student A/B/C）。
- 确保返回结果中对每题包含：总分、评分点详情、不可做项提示。

## 6. 测试与文档

- 增加 `tests/test_question_scope.py`：覆盖空输入、单题、区间、组合、非法输入。
- 为批次切分与重复检测编写单元/集成测试（例如构造无学生信息时 30 张图片拆分成两批、以及重复答案触发 Student B）。
- 编写集成测试（CLI 或最小 LangGraph mock）验证：
- 指定范围 `5-10` 时只批改这些题，其余题在结果中缺席。
- 当学生作答包含范围外题号时被跳过且无分值。
- 更新说明文档（如 `UPLOAD_FEATURE_SUMMARY.md` 或新增 `QUESTION_SCOPE_README.md`），解释题号输入格式、智能批次行为及评分逻辑。