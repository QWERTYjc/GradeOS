# Railway æ‰¹æ”¹æµç¨‹é—®é¢˜ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æ¦‚è¿°

æ ¹æ®ç”¨æˆ·æä¾›çš„æˆªå›¾å’Œæè¿°,å‘ç°ä»¥ä¸‹é—®é¢˜:

1. **Railway æ—¥å¿—è¾“å‡ºæ··ä¹±** - å¤§é‡ JSON è¾“å‡ºå¯¼è‡´æ—¥å¿—éš¾ä»¥é˜…è¯»
2. **é¢˜ç›®æ•°é‡æ˜¾ç¤ºé”™è¯¯** - å®é™…19é“é¢˜å´æ˜¾ç¤º42é“
3. **æµç¨‹æå‰ç»“æŸ** - è§£æå®Œæ‰¹æ”¹æ ‡å‡†åç›´æ¥è·³è½¬åˆ°ç»“æœé¡µ,æ²¡æœ‰è¿›å…¥æ‰¹æ”¹ç¯èŠ‚
4. **æ‰¹æ”¹ç»“æœé¡µç©ºç™½** - æœ€ç»ˆé¡µé¢æ²¡æœ‰æ˜¾ç¤ºä»»ä½•å†…å®¹

## æ ¹æœ¬åŸå› åˆ†æ

### 1. æ—¥å¿—æ··ä¹±é—®é¢˜

**ä½ç½®**: `backend/src/graphs/batch_grading.py` ç¬¬792-793è¡Œ

**åŸå› **: 
- ä»£ç ä½¿ç”¨ `logger.info()` è¾“å‡ºå®Œæ•´çš„ `parsed_rubric` JSON
- åœ¨ç”Ÿäº§ç¯å¢ƒ(Railway)ä¸­,è¿™ä¼šå¯¼è‡´æ—¥å¿—ä¸­å‡ºç°å¤§é‡çš„ JSON æ•°æ®
- å¯¹äºåŒ…å«å¤šé“é¢˜ç›®çš„æ‰¹æ”¹æ ‡å‡†,JSON å¯èƒ½æœ‰æ•°åƒè¡Œ

**ä¿®å¤**:
```python
# ä¿®å¤å‰:
logger.info(f"[rubric_parse] ğŸ“‹ AI è¿”å›çš„å®Œæ•´è¯„åˆ†æ ‡å‡† JSON:")
logger.info(f"[rubric_parse] {json.dumps(parsed_rubric, ensure_ascii=False, indent=2)}")

# ä¿®å¤å:
if logger.isEnabledFor(logging.DEBUG):
    logger.debug(f"[rubric_parse] ğŸ“‹ AI è¿”å›çš„å®Œæ•´è¯„åˆ†æ ‡å‡† JSON:")
    logger.debug(f"[rubric_parse] {json.dumps(parsed_rubric, ensure_ascii=False, indent=2)}")
else:
    # ç”Ÿäº§ç¯å¢ƒåªè¾“å‡ºé¢˜ç›®åˆ—è¡¨
    question_ids = [q.get('question_id', '?') for q in parsed_rubric.get('questions', [])]
    logger.info(f"[rubric_parse] é¢˜ç›®åˆ—è¡¨: {', '.join(question_ids)}")
```

### 2. é¢˜ç›®æ•°é‡é”™è¯¯é—®é¢˜

**ä½ç½®**: `backend/src/services/rubric_parser.py` ç¬¬326è¡Œ

**åŸå› **:
- Prompt æ¨¡æ¿ä¸­åŒ…å« `total_questions_found` å­—æ®µ
- LLM å¯èƒ½ä¼šå°†å­é¢˜(å¦‚ 7a, 7b)åˆ†åˆ«è®¡æ•°,å¯¼è‡´æ€»æ•°ç¿»å€
- ä¾‹å¦‚: å¦‚æœæœ‰é¢˜ç›® 1-7,æ¯é¢˜æœ‰2ä¸ªå­é¢˜,LLM å¯èƒ½è¿”å› 14 æˆ–æ›´å¤š

**ä¿®å¤**:
```python
# ä¿®å¤å‰:
{
  "rubric_format": "standard",
  "general_notes": "é€šç”¨æ‰¹æ”¹è¯´æ˜(å¦‚æœ‰)",
  "total_questions_found": å®é™…è¯†åˆ«åˆ°çš„é¢˜ç›®æ•°é‡,  # âŒ è¿™è¡Œå¯¼è‡´é—®é¢˜
  "overall_parse_confidence": 0.0-1.0ä¹‹é—´çš„æ•°å€¼,
  ...
}

# ä¿®å¤å:
{
  "rubric_format": "standard",
  "general_notes": "é€šç”¨æ‰¹æ”¹è¯´æ˜(å¦‚æœ‰)",
  "overall_parse_confidence": 0.0-1.0ä¹‹é—´çš„æ•°å€¼,  # âœ… ç§»é™¤äº† total_questions_found
  ...
}
```

ç°åœ¨é¢˜ç›®æ•°é‡ç”±ä»£ç è®¡ç®—: `len(all_questions)`,ç¡®ä¿å‡†ç¡®æ€§ã€‚

### 3. æµç¨‹æå‰ç»“æŸé—®é¢˜

**å¯èƒ½åŸå› **:
1. `grading_fanout_router` æ²¡æœ‰æ­£ç¡®åˆ›å»ºæ‰¹æ”¹ä»»åŠ¡
2. `processed_images` ä¸ºç©º,å¯¼è‡´ç›´æ¥è·³è½¬åˆ° `self_report`
3. `student_boundaries` é…ç½®é”™è¯¯

**æ·»åŠ çš„è°ƒè¯•æ—¥å¿—**:
```python
# åœ¨ grading_fanout_router ä¸­æ·»åŠ :
if not processed_images:
    logger.warning(f"[grading_fanout] âš ï¸ æ²¡æœ‰å¾…æ‰¹æ”¹çš„å›¾åƒ: batch_id={batch_id}")
    logger.warning(f"[grading_fanout] ğŸ” è°ƒè¯•: state keys={list(state.keys())}")
    logger.warning(f"[grading_fanout] ğŸ” answer_images count={len(state.get('answer_images', []))}")
    logger.warning(f"[grading_fanout] ğŸ” processed_images count={len(state.get('processed_images', []))}")
    return [Send("self_report", state)]

# åœ¨å­¦ç”Ÿæ‰¹æ¬¡åˆ›å»ºåæ·»åŠ :
if sends:
    logger.info(f"[grading_fanout] âœ… æˆåŠŸåˆ›å»º {len(sends)} ä¸ªå­¦ç”Ÿæ‰¹æ”¹ä»»åŠ¡")
    return sends
logger.warning(f"[grading_fanout] âš ï¸ æ²¡æœ‰æœ‰æ•ˆçš„å­¦ç”Ÿæ‰¹æ¬¡")
logger.warning(f"[grading_fanout] ğŸ” student_boundaries={student_boundaries}")
```

### 4. æ‰¹æ”¹ç»“æœé¡µç©ºç™½é—®é¢˜

**å¯èƒ½åŸå› **:
- å¦‚æœæ‰¹æ”¹æµç¨‹æ²¡æœ‰æ‰§è¡Œ,å°±ä¸ä¼šæœ‰ `student_results`
- å‰ç«¯ `ResultsView` ç»„ä»¶ä¾èµ– `finalResults` æ•°æ®
- å¦‚æœæ•°æ®ä¸ºç©º,é¡µé¢ä¼šæ˜¾ç¤ºä¸ºç©ºç™½

**éœ€è¦éªŒè¯**:
- æ‰¹æ”¹ä»»åŠ¡æ˜¯å¦æ­£ç¡®åˆ›å»º
- `grade_batch_node` æ˜¯å¦æ­£å¸¸æ‰§è¡Œ
- `student_results` æ˜¯å¦æ­£ç¡®èšåˆ

## ä¿®å¤æ–‡ä»¶æ¸…å•

### 1. `backend/src/services/rubric_parser.py`
- **ä¿®æ”¹**: ç§»é™¤ prompt ä¸­çš„ `total_questions_found` å­—æ®µ
- **å½±å“**: é˜²æ­¢ LLM è¿”å›é”™è¯¯çš„é¢˜ç›®è®¡æ•°

### 2. `backend/src/graphs/batch_grading.py`
- **ä¿®æ”¹1**: å°†å®Œæ•´ JSON æ—¥å¿—æ”¹ä¸º DEBUG çº§åˆ«
- **ä¿®æ”¹2**: æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
- **å½±å“**: 
  - ç”Ÿäº§ç¯å¢ƒæ—¥å¿—æ›´æ¸…æ™°
  - æ›´å®¹æ˜“è¯Šæ–­æ‰¹æ”¹æµç¨‹é—®é¢˜

### 3. `backend/debug_grading_flow.py` (æ–°æ–‡ä»¶)
- **ç”¨é€”**: è°ƒè¯•è„šæœ¬,ç”¨äºéªŒè¯ä¿®å¤
- **åŠŸèƒ½**:
  - æ£€æŸ¥ rubric parser æ˜¯å¦å·²ä¿®å¤
  - æ£€æŸ¥æ—¥å¿—é…ç½®
  - æµ‹è¯•æ‰¹æ”¹å›¾åˆ›å»º

## éªŒè¯æ­¥éª¤

### 1. è¿è¡Œè°ƒè¯•è„šæœ¬
```bash
cd backend
python debug_grading_flow.py
```

**é¢„æœŸè¾“å‡º**:
```
âœ… prompt å·²ä¿®å¤: ä¸å†åŒ…å« total_questions_found
âœ… æ—¥å¿—çº§åˆ«æ­£å¸¸,ä¸ä¼šè¾“å‡ºå®Œæ•´ JSON
âœ… æ‰¹æ”¹å›¾åˆ›å»ºæˆåŠŸ
ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡!
```

### 2. é‡å¯åç«¯æœåŠ¡
```bash
# Railway ä¼šè‡ªåŠ¨é‡å¯
# æˆ–è€…æœ¬åœ°æµ‹è¯•:
cd backend
python -m uvicorn src.api.main:app --reload --port 8001
```

### 3. æµ‹è¯•æ‰¹æ”¹æµç¨‹

1. **ä¸Šä¼ æ‰¹æ”¹ä»»åŠ¡**
   - ä¸Šä¼ 19é¡µç­”é¢˜å›¾åƒ
   - ä¸Šä¼ æ‰¹æ”¹æ ‡å‡†

2. **è§‚å¯Ÿ Railway æ—¥å¿—**
   - âœ… åº”è¯¥çœ‹åˆ°: `[rubric_parse] é¢˜ç›®åˆ—è¡¨: 1, 2, 3, ..., 19`
   - âœ… åº”è¯¥çœ‹åˆ°: `total_questions=19, total_score=105`
   - âœ… åº”è¯¥çœ‹åˆ°: `[grading_fanout] âœ… æˆåŠŸåˆ›å»º X ä¸ªå­¦ç”Ÿæ‰¹æ”¹ä»»åŠ¡`
   - âœ… åº”è¯¥çœ‹åˆ°: `[grade_batch] å¼€å§‹æ‰¹æ”¹æ‰¹æ¬¡ 1/X`
   - âŒ ä¸åº”è¯¥çœ‹åˆ°: å¤§é‡çš„ JSON è¾“å‡º

3. **æ£€æŸ¥æ‰¹æ”¹ç»“æœ**
   - âœ… ç»“æœé¡µåº”è¯¥æ˜¾ç¤ºæ‰¹æ”¹ç»“æœ
   - âœ… æ¯ä¸ªå­¦ç”Ÿçš„åˆ†æ•°å’Œæ‰¹æ³¨åº”è¯¥æ­£ç¡®æ˜¾ç¤º

## å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

### åœºæ™¯1: é¢˜ç›®æ•°é‡ä»ç„¶é”™è¯¯

**æ£€æŸ¥**:
```bash
# æŸ¥çœ‹ Railway æ—¥å¿—ä¸­çš„è¿™ä¸€è¡Œ:
[rubric_parse] è¯„åˆ†æ ‡å‡†è§£ææˆåŠŸ: é¢˜ç›®æ•°=?, æ€»åˆ†=?
```

**å¦‚æœé¢˜ç›®æ•°ä»ç„¶é”™è¯¯**:
- å¯èƒ½æ˜¯ LLM çš„è§£æé—®é¢˜
- æ£€æŸ¥æ‰¹æ”¹æ ‡å‡†å›¾åƒæ˜¯å¦æ¸…æ™°
- å°è¯•è°ƒæ•´ `RUBRIC_PARSE_MAX_PAGES` ç¯å¢ƒå˜é‡

### åœºæ™¯2: æµç¨‹ä»ç„¶æå‰ç»“æŸ

**æ£€æŸ¥ Railway æ—¥å¿—**:
```bash
# æŸ¥æ‰¾è¿™äº›å…³é”®æ—¥å¿—:
[grading_fanout] âš ï¸ æ²¡æœ‰å¾…æ‰¹æ”¹çš„å›¾åƒ
[grading_fanout] ğŸ” processed_images count=0
```

**å¦‚æœ processed_images ä¸ºç©º**:
- æ£€æŸ¥ `preprocess_node` æ˜¯å¦æ­£å¸¸æ‰§è¡Œ
- æ£€æŸ¥å‰ç«¯æ˜¯å¦æ­£ç¡®ä¸Šä¼ äº†å›¾åƒ
- æ£€æŸ¥ `answer_images` æ˜¯å¦æ­£ç¡®ä¼ é€’

**å¦‚æœ student_boundaries ä¸ºç©º**:
- æ£€æŸ¥å‰ç«¯æ˜¯å¦æä¾›äº† `student_mapping`
- æ£€æŸ¥ `_build_student_boundaries` å‡½æ•°

### åœºæ™¯3: æ‰¹æ”¹ç»“æœä»ç„¶ç©ºç™½

**æ£€æŸ¥ Railway æ—¥å¿—**:
```bash
# æŸ¥æ‰¾è¿™äº›å…³é”®æ—¥å¿—:
[grade_batch] å¼€å§‹æ‰¹æ”¹æ‰¹æ¬¡
[grade_batch] æ‰¹æ”¹å®Œæˆ
```

**å¦‚æœæ²¡æœ‰çœ‹åˆ°æ‰¹æ”¹æ—¥å¿—**:
- æ‰¹æ”¹ä»»åŠ¡å¯èƒ½æ²¡æœ‰åˆ›å»º
- æ£€æŸ¥ `grading_fanout_router` çš„æ—¥å¿—
- æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—

**å¦‚æœçœ‹åˆ°æ‰¹æ”¹æ—¥å¿—ä½†ç»“æœä¸ºç©º**:
- æ£€æŸ¥ `student_results` æ˜¯å¦æ­£ç¡®èšåˆ
- æ£€æŸ¥å‰ç«¯ API è°ƒç”¨æ˜¯å¦æˆåŠŸ
- æ£€æŸ¥ `getResultsReviewContext` æ¥å£

## åç»­ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ æ›´å¤šç›‘æ§æŒ‡æ ‡**
   - æ‰¹æ”¹ä»»åŠ¡åˆ›å»ºæ•°é‡
   - æ‰¹æ”¹æˆåŠŸ/å¤±è´¥ç‡
   - å¹³å‡æ‰¹æ”¹æ—¶é—´

2. **æ”¹è¿›é”™è¯¯å¤„ç†**
   - æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
   - è‡ªåŠ¨é‡è¯•æœºåˆ¶
   - å¤±è´¥é€šçŸ¥

3. **ä¼˜åŒ–æ—¥å¿—è¾“å‡º**
   - ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—(JSONæ ¼å¼)
   - æ·»åŠ  trace ID è·Ÿè¸ªè¯·æ±‚
   - é›†æˆæ—¥å¿—åˆ†æå·¥å…·(å¦‚ Sentry)

4. **æ€§èƒ½ä¼˜åŒ–**
   - æ‰¹æ”¹ä»»åŠ¡å¹¶å‘æ§åˆ¶
   - å›¾åƒå‹ç¼©ä¼˜åŒ–
   - ç¼“å­˜æ‰¹æ”¹æ ‡å‡†

## è”ç³»æ”¯æŒ

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨,è¯·æä¾›:
1. Railway å®Œæ•´æ—¥å¿—(ä»ä¸Šä¼ åˆ°ç»“æœé¡µ)
2. æ‰¹æ”¹æ ‡å‡†å›¾åƒ(è„±æ•å)
3. ç­”é¢˜å›¾åƒæ•°é‡
4. é¢„æœŸé¢˜ç›®æ•°é‡å’Œæ€»åˆ†

---

**ä¿®å¤æ—¶é—´**: 2026-01-31
**ä¿®å¤ç‰ˆæœ¬**: v1.0.1
**ä¿®å¤äºº**: AI Assistant
