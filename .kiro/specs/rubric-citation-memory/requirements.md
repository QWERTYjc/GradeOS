# 评分标准引用与记忆系统优化 - 需求文档

## 功能概述

优化 AI 批改系统，实现：
1. 评分时强制引用具体评分标准条目
2. 另类解法的置信度调整机制
3. 自白驱动的记忆自我迭代
4. 逻辑复核的独立性保证

## 用户故事

### 1. 评分标准引用

#### 1.1 强制引用评分标准
**作为** 教师
**我希望** AI 批改时明确引用具体的评分标准条目
**以便** 我能快速验证评分依据的正确性

**验收标准：**
- [ ] 每个得分点必须包含 `rubric_reference` 字段，引用具体的评分标准条目（如 "1.2.a"）
- [ ] 如果无法找到匹配的评分标准，必须标记为 `rubric_reference: null` 并降低置信度
- [ ] 引用格式统一为 `{question_id}.{point_id}` 或评分标准原文摘要

#### 1.2 另类解法处理
**作为** 教师
**我希望** AI 能识别学生的另类解法并适当调整置信度
**以便** 我能重点关注需要人工判断的答案

**验收标准：**
- [ ] 当学生使用另类解法时，`is_alternative_solution` 标记为 true
- [ ] 另类解法的置信度自动降低 20-30%（可配置）
- [ ] 另类解法仍然正常评分，但在自白中标记为"需要人工确认"
- [ ] 记录另类解法的描述和评分依据

#### 1.3 置信度与引用关联
**作为** 系统
**我希望** 置信度计算考虑评分标准引用的质量
**以便** 更准确地反映评分的可靠性

**验收标准：**
- [ ] 有明确引用的得分点，置信度基础值为 0.9
- [ ] 无法引用的得分点，置信度上限为 0.7
- [ ] 另类解法的得分点，置信度上限为 0.75
- [ ] 整体置信度为各得分点置信度的加权平均

### 2. 记忆系统优化

#### 2.1 自白驱动的记忆更新
**作为** 系统
**我希望** 自白结果能自动反馈到记忆系统
**以便** AI 能从错误中学习并持续改进

**验收标准：**
- [ ] 自白中发现的问题自动创建记忆条目
- [ ] 记忆条目包含：问题类型、上下文、教训、科目
- [ ] 新记忆默认为"待验证"状态（`verified: false`）
- [ ] 相同模式重复出现时，增加 `occurrence_count` 并提升重要性

#### 2.2 记忆分层与可审计
**作为** 管理员
**我希望** 记忆系统是分层的、可审计的、可回滚的
**以便** 我能管理和纠正错误的记忆

**验收标准：**
- [ ] 记忆分为三层：待验证 → 已验证 → 核心记忆
- [ ] 每条记忆记录创建时间、来源批次、验证历史
- [ ] 支持按科目、时间范围、重要性查询记忆
- [ ] 支持软删除和回滚记忆

#### 2.3 记忆验证机制
**作为** 系统
**我希望** 记忆能通过后续批改结果自动验证
**以便** 区分可靠记忆和错误记忆

**验收标准：**
- [ ] 当记忆被后续批改确认时，`confirmation_count` 增加
- [ ] 当记忆被后续批改否定时，`contradiction_count` 增加
- [ ] 可信度 = confirmation / (confirmation + contradiction)
- [ ] 可信度低于 0.3 的记忆自动标记为"可疑"

### 3. 逻辑复核独立性

#### 3.1 无记忆的逻辑复核
**作为** 系统
**我希望** 逻辑复核节点不访问记忆系统
**以便** 提供独立、客观的第二意见

**验收标准：**
- [ ] 逻辑复核函数不接收记忆相关参数
- [ ] 逻辑复核只基于当前评分结果和评分标准进行验证
- [ ] 逻辑复核结果与记忆系统的建议进行对比，差异记录到自白

#### 3.2 记忆与复核的制衡
**作为** 系统
**我希望** 逻辑复核能发现记忆导致的系统性偏差
**以便** 及时纠正错误的记忆

**验收标准：**
- [ ] 当逻辑复核与记忆建议冲突时，触发"记忆审查"流程
- [ ] 记忆审查结果记录到记忆条目的 `contradiction_count`
- [ ] 连续 3 次冲突的记忆自动降级为"待验证"

## 非功能需求

### 性能
- 记忆检索延迟 < 50ms
- 单次批改的记忆更新不超过 10 条

### 可观测性
- 记忆系统操作记录到日志
- 提供记忆统计 API（总数、分布、可信度分布）

### 兼容性
- 与现有 `grading_memory.py` 兼容
- 不破坏现有 API 接口

## 技术约束

- 使用现有的 `MemoryEntry` 数据结构
- 使用现有的 `GradingMemoryService` 服务
- 评分标准引用格式需与前端展示兼容
