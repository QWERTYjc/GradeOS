apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: cognitive-worker-scaler
  namespace: grading-system
spec:
  scaleTargetRef:
    name: cognitive-worker
  pollingInterval: 15  # 每 15 秒检查一次指标
  cooldownPeriod: 60   # 缩容冷却期 60 秒
  minReplicaCount: 2   # 最小副本数
  maxReplicaCount: 10  # 最大副本数
  
  # 扩缩容行为配置
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 300  # 缩容稳定窗口 5 分钟
          policies:
          - type: Percent
            value: 50
            periodSeconds: 60
          - type: Pods
            value: 2
            periodSeconds: 60
          selectPolicy: Min
        scaleUp:
          stabilizationWindowSeconds: 0  # 立即扩容
          policies:
          - type: Percent
            value: 100
            periodSeconds: 15
          - type: Pods
            value: 4
            periodSeconds: 15
          selectPolicy: Max
  
  triggers:
  # 基于 Temporal 队列深度的扩缩容
  - type: external
    metadata:
      scalerAddress: temporal-keda-scaler.keda:9090
      namespace: default
      taskQueue: vision-compute-queue
      targetValue: "5"  # 每个 worker 处理 5 个任务时触发扩容
  
  # 备用触发器：基于 CPU 使用率
  - type: cpu
    metricType: Utilization
    metadata:
      value: "70"  # CPU 使用率超过 70% 时扩容
  
  # 备用触发器：基于内存使用率
  - type: memory
    metricType: Utilization
    metadata:
      value: "80"  # 内存使用率超过 80% 时扩容
---
# KEDA TriggerAuthentication for Temporal (if needed)
apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: temporal-trigger-auth
  namespace: grading-system
spec:
  secretTargetRef:
  - parameter: temporalAddress
    name: temporal-connection
    key: address
  - parameter: temporalNamespace
    name: temporal-connection
    key: namespace
---
# Secret for Temporal connection (if using authentication)
apiVersion: v1
kind: Secret
metadata:
  name: temporal-connection
  namespace: grading-system
type: Opaque
stringData:
  address: "temporal-frontend.temporal:7233"
  namespace: "default"
