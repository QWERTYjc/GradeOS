# 需求文档

## 简介

本文档定义了一套生产级、纯视觉（Vision-Native）AI 批改系统的需求规范。该系统摒弃传统 OCR 方案，直接利用多模态大模型（Gemini 3.0 Pro 和 Gemini 2.5 Flash Lite）对试卷图像进行端到端的语义理解与评估。系统采用 Temporal 作为分布式工作流编排引擎，结合 LangGraph 构建动态派生智能体架构，通过 SupervisorAgent 根据题型动态调度专业批改智能体（ObjectiveAgent、StepwiseAgent、EssayAgent 等），实现对学生解题步骤的深度逻辑验证。

## 术语表

- **VLM (Vision Language Model)**: 视觉语言模型，能够直接理解图像内容并进行推理的多模态模型
- **Temporal**: 分布式工作流编排引擎，提供持久化执行能力
- **LangGraph**: 基于图结构的智能体框架，支持循环推理和状态管理
- **SupervisorAgent（总控调度智能体）**: 负责分析题型并动态派生合适的批改智能体
- **Agent Pool（智能体池）**: 包含多种专业批改智能体的可扩展池
- **Context Pack（上下文包）**: 传递给批改智能体的结构化上下文，包含题目图像、评分细则、术语等
- **Rubric（评分细则）**: 定义每道题目的评分标准和得分点
- **Bounding Box（边界框）**: 用于标识图像中特定区域的坐标 [ymin, xmin, ymax, xmax]
- **Confidence Score（置信度分数）**: 表示 AI 对评分结果的确信程度
- **Fan-Out/Fan-In（扇出/扇入）**: 用于并行处理多个子任务并汇聚结果的模式
- **Checkpoint（检查点）**: LangGraph 状态的持久化快照
- **Perceptual Hash（感知哈希）**: 用于计算图像的相似度指纹
- **Evidence Chain（证据链）**: 每个得分点对应的文本片段、图像位置、理由与引用的评分条目

## 需求列表

### 需求 1：试卷提交与预处理

**用户故事：** 作为教师或学生，我希望能够上传 PDF 或图像格式的试卷，以便系统能够自动进行批改处理。

#### 验收标准

1. 当用户上传 PDF 文件时，提交服务应当以 300 DPI 将 PDF 转换为高分辨率图像
2. 当用户上传图像文件时，提交服务应当验证图像格式和质量
3. 当文件预处理成功完成时，提交服务应当在 5 秒内将图像持久化到对象存储并返回 submission_id
4. 当文件预处理完成时，提交服务应当异步启动 Temporal 工作流
5. 如果文件上传因格式无效而失败，提交服务应当返回描述性错误消息，说明支持的格式

### 需求 2：纯视觉页面分割

**用户故事：** 作为批改系统，我希望使用视觉模型识别试卷中的题目边界，以便每道题目能够被独立提取和批改。

#### 验收标准

1. 当布局分析服务接收到页面图像时，服务应当调用 Gemini 2.5 Flash Lite 识别题目边界
2. 当题目边界被识别后，服务应当返回包含 question_id 和边界框坐标 [ymin, xmin, ymax, xmax] 的结构化 JSON
3. 当坐标以归一化格式（0-1000 比例）返回时，服务应当根据实际图像尺寸将其转换为像素坐标
4. 如果模型未能识别任何题目区域，服务应当将该页面标记为需要人工审核
5. 当单页存在多道题目时，服务应当按顺序返回所有题目区域

### 需求 3：动态派生智能体批改

**用户故事：** 作为批改系统，我希望使用 LangGraph 动态派生智能体架构对每道题目进行深度推理批改，以便不同题型能够由专业智能体处理，评分结果准确且可解释。

#### 验收标准

1. 当 SupervisorAgent 接收到题目图像时，智能体应当分析题型并从 Agent Pool 中选择合适的批改智能体
2. 当 SupervisorAgent 派生批改智能体时，智能体应当构建包含题目图像、评分细则、相关术语的 Context Pack
3. 当批改智能体接收到 Context Pack 时，智能体应当执行包含视觉提取、评分映射和自我反思的多步推理过程
4. 当视觉提取节点处理图像时，节点应当生成学生解题步骤的详细文字描述
5. 当评分映射节点评估解答时，节点应当将每个评分点映射到视觉分析中的具体证据，形成证据链
6. 当反思节点审查评分时，节点应当识别潜在的评分错误并生成修正反馈
7. 当存在反思反馈且修正次数少于 3 次时，智能体应当带着反馈循环回到评分节点
8. 当批改结果置信度低于阈值时，SupervisorAgent 应当调度额外智能体进行二次评估
9. 当智能体完成推理时，智能体应当输出最终分数、置信度分数、证据链和推理轨迹
10. 当每次状态转换发生时，LangGraph 运行时应当将检查点持久化到 PostgreSQL 以供审计追踪

### 需求 11：多题型智能体支持

**用户故事：** 作为教师，我希望系统能够针对不同题型使用专业的批改智能体，以便选择题、计算题、作文题等都能得到精准评分。

#### 验收标准

1. 当系统接收到选择题或判断题时，ObjectiveAgent 应当依据标准答案进行精确比对
2. 当系统接收到数学或物理计算题时，StepwiseAgent 应当将解题过程拆解为步骤并按评分细则逐步给分
3. 当系统接收到作文或简答题时，EssayAgent 应当依据内容、结构、语言等维度进行综合评分
4. 当系统接收到实验设计题时，LabDesignAgent 应当评估实验方案的完整性和科学性
5. 当新增题型批改插件时，系统应当通过标准接口注册而不修改主流程
6. 当批改智能体返回结果时，结果应当包含题型标识和使用的智能体类型

### 需求 4：Temporal 工作流编排

**用户故事：** 作为系统管理员，我希望使用 Temporal 编排批改任务，以便任务执行具备持久化、重试和故障恢复能力。

#### 验收标准

1. 当收到提交时，试卷工作流应当编排从分割到结果聚合的完整批改生命周期
2. 当页面分割完成时，工作流应当为每道题目并行扇出子工作流
3. 当所有子工作流完成时，工作流应当聚合结果并计算总分
4. 如果任何批改活动失败，Temporal 运行时应当根据配置的重试策略重试活动，最多 3 次
5. 如果工作节点在执行期间崩溃，Temporal 运行时应当在健康的工作节点上从最后的检查点恢复工作流
6. 当工作流状态变化时，工作流应当更新数据库中的提交状态

### 需求 5：人工审核介入

**用户故事：** 作为教师，我希望在 AI 置信度较低时介入审核，以便批改结果的准确性得到保障。

#### 验收标准

1. 当任何题目的置信度分数低于 0.75 时，工作流应当转换到审核状态并等待人工介入
2. 当工作流进入审核状态时，系统应当向指定教师发送通知
3. 当教师发送带有批准操作的审核信号时，工作流应当继续使用 AI 生成的结果
4. 当教师发送带有覆盖操作的审核信号时，工作流应当应用教师的手动评分
5. 当教师发送带有拒绝操作的审核信号时，工作流应当终止并将提交标记为已拒绝
6. 当工作流等待人工审核时，工作流应当保持挂起状态而不消耗计算资源

### 需求 6：语义缓存与去重

**用户故事：** 作为系统运维人员，我希望缓存相似题目的批改结果，以便系统能够降低 API 调用成本并提高响应速度。

#### 验收标准

1. 当接收到题目图像进行批改时，缓存服务应当计算图像的感知哈希
2. 当存在相同评分细则哈希和图像哈希组合的缓存条目时，服务应当返回缓存结果而不调用 LLM
3. 当生成置信度高于 0.9 的新批改结果时，服务应当将结果存储到 Redis 缓存
4. 当缓存查找或存储失败时，服务应当继续正常批改而不中断
5. 当缓存条目年龄超过 30 天时，缓存服务应当使该条目失效

### 需求 7：结果存储与证据链可追溯性

**用户故事：** 作为教师，我希望查看 AI 批改的完整推理过程和证据链，以便我能够理解每个得分点的评分依据并进行复核。

#### 验收标准

1. 当题目批改完成时，存储服务应当将分数、置信度、视觉标注、证据链和智能体轨迹持久化到 PostgreSQL
2. 当存储视觉标注时，服务应当包含用于在原图上高亮错误的边界框坐标
3. 当存储证据链时，服务应当为每个得分点记录对应的图像区域、文本描述、评分理由和引用的评分条目
4. 当存储智能体轨迹时，服务应当以 JSONB 格式包含视觉分析、推理步骤、反思反馈和使用的智能体类型
5. 当用户查询批改历史时，服务应当返回完整的推理轨迹和证据链以供审计
6. 当存储结果时，服务应当使用复合键（submission_id, question_id）以便高效检索

### 需求 8：高并发与水平扩展

**用户故事：** 作为系统架构师，我希望系统能够处理考试结束后的提交洪峰，以便服务在高负载下保持稳定响应。

#### 验收标准

1. 当视觉计算任务在队列中累积时，Kubernetes KEDA 扩缩器应当根据 ScheduleToStartLatency 指标增加工作节点 Pod 数量
2. 当任务队列深度降低时，KEDA 扩缩器应当缩减工作节点 Pod 以减少资源消耗
3. 当接近 API 速率限制时，限流器应当使用 Redis 中的滑动窗口算法限制请求
4. 当同一提交的多道题目准备就绪时，工作流应当使用异步扇出模式并行处理它们
5. 当系统负载较高时，系统应当将单题批改响应延迟保持在 30 秒以下

### 需求 9：评分细则管理

**用户故事：** 作为教师，我希望为每道题目配置评分细则，以便 AI 能够按照标准进行精确评分。

#### 验收标准

1. 当教师创建评分细则时，评分细则服务应当存储评分细则文本、分值分配和关联的 exam_id
2. 当评分细则与题目关联时，服务应当将评分细则链接到题目的边界框区域
3. 当批改题目时，批改智能体应当从数据库检索相应的评分细则
4. 当评分细则更新时，服务应当使相关缓存条目失效
5. 如果题目不存在评分细则，系统应当将该题目标记为需要手动配置后才能批改

### 需求 10：质量控制与评估

**用户故事：** 作为质量保证工程师，我希望持续监控 AI 批改的准确性，以便系统能够及时发现并修正评分偏差。

#### 验收标准

1. 当部署新模型版本时，质量控制流水线应当在包含 500 份标注样本的黄金数据集上运行验证
2. 当验证完成时，流水线应当计算与人工评分的皮尔逊相关系数和科恩 Kappa 系数
3. 如果相关系数低于 0.9 或 Kappa 低于 0.8，流水线应当阻止部署
4. 当系统在生产环境运行时，质量控制服务应当随机抽取 5% 的高置信度提交进行人工双盲审核
5. 当检测到显著评分偏差时，系统应当触发警报并将受影响的题目类型标记为需要强制人工审核
