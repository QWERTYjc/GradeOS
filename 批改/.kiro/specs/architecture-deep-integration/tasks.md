# 实现计划

- [x] 1. 实现统一连接池管理器






  - [x] 1.1 创建 UnifiedPoolManager 单例类

    - 实现 PostgreSQL 连接池初始化（psycopg_pool）
    - 实现 Redis 连接池初始化（redis.asyncio）
    - 实现连接获取和归还的上下文管理器
    - 实现健康检查方法
    - _需求：2.1, 8.1, 8.2_

  - [x] 1.2 编写连接池资源管理的属性测试

    - **属性 15：连接池资源管理**
    - **验证：需求 8.2, 8.4**
  - [x] 1.3 实现优雅关闭机制


    - 等待进行中的操作完成
    - 关闭所有连接
    - 配置关闭超时
    - _需求：8.5_

  - [x] 1.4 实现连接超时处理

    - 配置获取连接超时
    - 返回明确的错误信息
    - _需求：8.4_


- [x] 2. 实现增强型 LangGraph 检查点器




  - [x] 2.1 创建 EnhancedPostgresCheckpointer 类


    - 继承 BaseCheckpointSaver
    - 集成 UnifiedPoolManager
    - 实现 put/get 方法


    - _需求：9.1, 9.2_
  - [ ] 2.2 实现增量状态存储
    - 计算状态增量（delta）


    - 仅保存变化的部分

    - 支持从增量重建完整状态
    - _需求：9.1_
  - [ ] 2.3 编写检查点存储效率的属性测试
    - **属性 16：检查点存储效率**

    - **验证：需求 9.1, 9.3**
  - [ ] 2.4 实现数据压缩
    - 检测数据大小是否超过 1MB
    - 使用 zlib 压缩大数据


    - 存储时标记是否压缩

    - _需求：9.3_
  - [ ] 2.5 实现历史检查点恢复
    - 实现 get_by_id 方法


    - 实现 list_checkpoints 方法

    - 支持从任意历史检查点恢复
    - _需求：9.2_
  - [x] 2.6 编写历史检查点恢复的属性测试






    - **属性 17：历史检查点恢复**






    - **验证：需求 9.2**
  - [ ] 2.7 实现保存重试机制
    - 保存失败时重试最多 3 次


    - 3 次失败后标记需要人工干预
    - _需求：9.4_


  - [x] 2.8 编写检查点保存重试的属性测试


    - **属性 18：检查点保存重试**
    - **验证：需求 9.4**
  - [x] 2.9 集成 Temporal Activity Heartbeat


    - 在保存检查点时调用心跳回调


    - 报告当前进度
    - _需求：1.2_
  - [x] 2.10 编写 Activity 心跳进度报告的属性测试


    - **属性 2：Activity 心跳进度报告**


    - **验证：需求 1.2**




- [x] 3. 检查点 - 确保连接池和检查点器测试通过




  - 确保所有测试通过，如有问题请询问用户。



- [ ] 4. 实现多层缓存服务



  - [ ] 4.1 创建 MultiLayerCacheService 类
    - 集成 UnifiedPoolManager
    - 实现 Pub/Sub 通道订阅

    - 实现降级标志管理
    - _需求：3.1, 3.2, 3.5_
  - [x] 4.2 实现 Write-Through 写入策略

    - 同时写入 Redis 和 PostgreSQL
    - 任一失败时执行补偿
    - _需求：3.1_

  - [ ] 4.3 编写写入同步一致性的属性测试
    - **属性 5：写入同步一致性**







    - **验证：需求 3.1, 3.4**

  - [x] 4.4 实现带降级的缓存查询



    - 先查 Redis，未命中查 PostgreSQL
    - PostgreSQL 结果回填 Redis

    - Redis 故障时自动降级
    - _需求：3.2, 3.5_
  - [ ] 4.5 编写缓存查询顺序正确性的属性测试
    - **属性 6：缓存查询顺序正确性**

    - **验证：需求 3.2**
  - [ ] 4.6 实现 Pub/Sub 缓存失效通知
    - 发布失效消息到通道
    - 订阅并处理失效消息
    - 失效本地缓存
    - _需求：3.3_
  - [ ] 4.7 编写缓存失效通知传播的属性测试
    - **属性 7：缓存失效通知传播**
    - **验证：需求 3.3**
  - [ ] 4.8 实现工作流状态同步
    - 状态变更时同步到 Redis
    - 支持实时查询
    - _需求：3.4_


- [ ] 5. 实现分布式事务协调器

  - [ ] 5.1 创建 DistributedTransactionCoordinator 类
    - 定义 SagaStep 数据类
    - 定义 SagaStepStatus 枚举
    - 集成 UnifiedPoolManager
    - _需求：4.1_
  - [ ] 5.2 实现 Saga 事务执行
    - 按顺序执行步骤
    - 记录每步状态
    - 失败时触发补偿
    - _需求：4.1, 4.2_
  - [ ] 5.3 编写补偿操作正确性的属性测试
    - **属性 8：补偿操作正确性**
    - **验证：需求 4.2**
  - [ ] 5.4 实现补偿操作
    - 逆序执行已完成步骤的补偿
    - 记录补偿结果
    - _需求：4.2_
  - [ ] 5.5 实现事务日志记录
    - 记录事务开始、步骤执行、最终状态
    - 支持人工干预查询
    - _需求：4.5_
  - [ ] 5.6 实现部分状态清理
    - Activity 超时时清理部分写入
    - _需求：4.3_
  - [ ] 5.7 实现审核覆盖事务
    - 数据库更新、缓存失效、通知发送在单个 Saga 中
    - _需求：4.4_
  - [ ] 5.8 编写审核覆盖事务原子性的属性测试
    - **属性 9：审核覆盖事务原子性**
    - **验证：需求 4.4**

- [ ] 6. 检查点 - 确保缓存和事务测试通过

  - 确保所有测试通过，如有问题请询问用户。


- [x] 7. 实现端到端追踪服务

  - [x] 7.1 创建 TracingService 类
    - 定义 TraceSpan 数据类
    - 定义 SpanKind 枚举
    - 集成 UnifiedPoolManager
    - _需求：5.1, 5.2, 5.3_
  - [x] 7.2 实现 trace_id 生成和传递
    - 生成唯一 trace_id
    - 创建和结束 span
    - 持久化 span 到数据库
    - _需求：5.1_
  - [x] 7.3 编写追踪标识传递完整性的属性测试
    - **属性 10：追踪标识传递完整性**
    - **验证：需求 5.1, 5.2, 5.3**
  - [x] 7.4 实现追踪查询
    - 根据 trace_id 查询完整链路
    - 返回所有相关 span
    - _需求：5.4_
  - [x] 7.5 实现性能告警

    - 检测 span 持续时间
    - 超过阈值时触发告警
    - _需求：5.5_

- [x] 8. 实现增强型 Temporal 工作流





  - [x] 8.1 创建 EnhancedWorkflowMixin 类


    - 实现进度查询（Temporal Query）
    - 实现外部事件接收（Signal）
    - _需求：10.1, 10.2_
  - [x] 8.2 实现状态标识一致性


    - 将 workflow_run_id 作为 thread_id 传递给 LangGraph
    - 确保 Query 返回最新状态
    - _需求：1.1, 1.5_
  - [x] 8.3 编写状态标识一致性的属性测试


    - **属性 1：状态标识一致性**
    - **验证：需求 1.1, 1.5**
  - [x] 8.4 实现重试策略决策


    - 检查点存在时从检查点恢复
    - 检查点不存在或损坏时重新开始
    - _需求：1.4_
  - [x] 8.5 编写重试策略决策正确性的属性测试


    - **属性 3：重试策略决策正确性**
    - **验证：需求 1.4**
  - [x] 8.6 实现 Redis 事件接收


    - 通过 Redis Pub/Sub 接收外部事件
    - 转发到工作流 Signal
    - _需求：10.1_
  - [x] 8.7 编写 Redis 事件接收的属性测试


    - **属性 19：Redis 事件接收**
    - **验证：需求 10.1**
  - [x] 8.8 实现进度查询

    - 更新进度信息
    - 通过 Query 暴露进度
    - _需求：10.2_
  - [x] 8.9 编写工作流进度查询的属性测试


    - **属性 20：工作流进度查询**
    - **验证：需求 10.2**
  - [x] 8.10 实现分布式锁

    - 获取 Redis 分布式锁
    - 释放锁
    - 处理锁超时
    - _需求：10.4_
  - [x] 8.11 编写分布式锁互斥性的属性测试


    - **属性 22：分布式锁互斥性**
    - **验证：需求 10.4**
  - [x] 8.12 实现批量子工作流并发控制

    - 限制同时运行的子工作流数量
    - 使用信号量控制并发
    - _需求：10.3_
  - [x] 8.13 编写批量子工作流并发控制的属性测试


    - **属性 21：批量子工作流并发控制**
    - **验证：需求 10.3**

- [x] 9. 检查点 - 确保追踪和工作流测试通过





  - 确保所有测试通过，如有问题请询问用户。






- [x] 10. 实现增强型 API 服务






  - [x] 10.1 创建 EnhancedAPIService 类

    - 集成 UnifiedPoolManager
    - 集成 TracingService
    - 配置慢查询阈值

    - _需求：7.1, 7.2, 7.3_
  - [x] 10.2 实现 WebSocket 实时推送

    - 处理 WebSocket 连接
    - 订阅 Redis 状态变更通道


    - 推送状态变更到客户端
    - _需求：7.1_
  - [x] 10.3 实现分页查询

    - 支持 page 和 page_size 参数


    - 支持 sort_by 和 sort_order 参数
    - 支持 filters 参数
    - _需求：7.2_
  - [x] 10.4 编写分页查询结果正确性的属性测试


    - **属性 12：分页查询结果正确性**



    - **验证：需求 7.2**
  - [x] 10.5 实现字段选择查询

    - 支持 fields 参数
    - 仅返回请求的字段
    - _需求：7.3_
  - [x] 10.6 编写字段选择查询正确性的属性测试







    - **属性 13：字段选择查询正确性**

    - **验证：需求 7.3**
  - [x] 10.7 实现限流响应

    - 超过阈值返回 429
    - 包含 Retry-After 头
    - _需求：7.5_
  - [x] 10.8 编写限流响应正确性的属性测试


    - **属性 14：限流响应正确性**
    - **验证：需求 7.5**
  - [x] 10.9 实现慢查询监控

    - 记录超过阈值的查询
    - 触发告警
    - _需求：7.4_


- [x] 11. 实现持久化事务原子性

  - [x] 11.1 更新 GradingResultRepository
    - 在单个事务中保存 grading_results 和更新 submissions
    - 使用 UnifiedPoolManager 的事务连接
    - _需求：2.2_
  - [x] 11.2 编写持久化事务原子性的属性测试

    - **属性 4：持久化事务原子性**
    - **验证：需求 2.2, 2.3**
  - [x] 11.3 更新检查点保存逻辑



    - 检查点与批改中间结果在同一事务中
    - _需求：2.3_


- [x] 12. 实现智能缓存预热





  - [x] 12.1 实现启动预热


    - 从 PostgreSQL 加载最近 7 天高置信度结果
    - 异步加载到 Redis
    - _需求：6.1_
  - [x] 12.2 实现评分细则哈希预计算


    - 创建评分细则时预计算哈希
    - 缓存哈希值
    - _需求：6.2_
  - [x] 12.3 编写评分细则哈希预计算的属性测试


    - **属性 11：评分细则哈希预计算**
    - **验证：需求 6.2**
  - [x] 12.4 实现异步批量预热

    - 批量导入时异步预热
    - 不阻塞主流程
    - _需求：6.4_


- [x] 13. 检查点 - 确保 API 和预热测试通过






  - 确保所有测试通过，如有问题请询问用户。



- [x] 14. 更新现有组件集成





  - [x] 14.1 更新 GradingAgent 使用增强检查点器


    - 替换原有 PostgresSaver
    - 配置心跳回调
    - _需求：1.2, 9.1_
  - [x] 14.2 更新 ExamPaperWorkflow 使用增强混入


    - 继承 EnhancedWorkflowMixin
    - 添加进度更新
    - _需求：10.2_
  - [x] 14.3 更新 CacheService 使用多层缓存


    - 替换原有缓存服务
    - 配置 Write-Through 策略
    - _需求：3.1, 3.2_
  - [x] 14.4 更新 API 路由使用增强服务


    - 添加 WebSocket 端点
    - 添加分页和字段选择参数
    - _需求：7.1, 7.2, 7.3_
  - [x] 14.5 更新数据库初始化使用统一连接池


    - 替换原有数据库连接
    - 配置共享连接池

    - _需求：2.1_

- [x] 15. 创建数据库迁移







  - [x] 15.1 创建追踪表迁移

    - 创建 trace_spans 表
    - 创建索引
    - _需求：5.4_
  - [x] 15.2 创建 Saga 事务日志表迁移

    - 创建 saga_transactions 表
    - 创建索引
    - _需求：4.5_
  - [x] 15.3 更新检查点表迁移

    - 添加 is_compressed、is_delta、base_checkpoint_id、data_size_bytes 字段
    - _需求：9.1, 9.3_
  - [x] 15.4 创建工作流状态缓存表迁移

    - 创建 workflow_state_cache 表
    - _需求：3.5_


- [x] 16. 更新 Kubernetes 配置






  - [x] 16.1 更新 ConfigMap



    - 添加连接池配置
    - 添加缓存配置
    - 添加追踪配置
    - _需求：8.1_
  - [x] 16.2 更新 Deployment


    - 配置健康检查端点
    - 配置资源限制
    - _需求：8.1_
  - [x] 16.3 添加监控配置


    - 配置 Prometheus 指标
    - 配置告警规则
    - _需求：5.5_


- [x] 17. 编写集成测试

  - [x] 17.1 编写 Temporal-LangGraph 状态同步集成测试



    - 测试工作流启动智能体
    - 测试崩溃恢复
    - _需求：1.1, 1.3_


  - [x] 17.2 编写 Redis 降级集成测试
    - 模拟 Redis 故障
    - 验证自动降级到 PostgreSQL
    - _需求：3.5_
  - [x] 17.3 编写分布式事务集成测试
    - 测试 Saga 执行
    - 测试补偿操作
    - _需求：4.1, 4.2_
  - [x] 17.4 编写 WebSocket 推送集成测试

    - 测试连接建立
    - 测试状态推送
    - _需求：7.1_


- [x] 18. 最终检查点 - 确保所有测试通过






  - 确保所有测试通过，如有问题请询问用户。
